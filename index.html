<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åºŸåœŸè¡ŒåŠ¨ - Pixel Extraction RPG</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- å¼•å…¥ Babel ç”¨äºè§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts åƒç´ å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #171717;
            color: #e2e8f0;
            overflow-y: auto; 
            font-family: 'VT323', monospace; 
            touch-action: manipulation;
        }
        .pixel-font { 
            font-family: 'VT323', monospace; 
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.3);
        }
        .game-container { 
            font-family: 'VT323', monospace; 
            font-size: 1.25rem; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out; }

        @keyframes shake {
            0%, 100% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(1px, -1px) rotate(1deg); }
        }
        .shake-anim { animation: shake 0.5s; }
        
        .bg-noise { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        
        @keyframes pulse-gold {
            0%, 100% { border-color: #ca8a04; box-shadow: 0 0 5px #ca8a04; }
            50% { border-color: #facc15; box-shadow: 0 0 15px #facc15, inset 0 0 10px #facc15; }
        }
        .fever-mode { animation: pulse-gold 1s infinite; }

        @keyframes pulse-victory {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.02); filter: brightness(1.3); }
        }
        .victory-pulse { animation: pulse-victory 2s infinite ease-in-out; }

        .min-h-safe { min-height: 100vh; min-height: 100dvh; }

        @keyframes spin-blur { 0% { filter: blur(2px); transform: translateY(-10%); } 50% { filter: blur(4px); transform: translateY(10%); } 100% { filter: blur(2px); transform: translateY(-10%); } }
        @keyframes pop-in { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes win-pulse { 0%,100% { box-shadow: 0 0 6px #facc15; } 50% { box-shadow: 0 0 18px #facc15; } }
        
        @keyframes teaser-spin { 
            0% { filter: blur(2px) drop-shadow(0 0 5px #ef4444); transform: translateY(-10%); } 
            50% { filter: blur(4px) brightness(1.3) drop-shadow(0 0 20px #ef4444); transform: translateY(10%); } 
            100% { filter: blur(2px) drop-shadow(0 0 5px #ef4444); transform: translateY(-10%); } 
        }

        .slot-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
        .slot-col { display: grid; grid-template-rows: repeat(3, 1fr); gap: 0.35rem; }
        .slot-cell { background: #cbd5e1; border: 4px solid #475569; color: #0f172a; font-size: clamp(1.4rem, 7vw, 2rem); display: flex; align-items: center; justify-content: center; height: 64px; line-height: 1; overflow: hidden; }
        .text-blur-out { animation: spin-blur 0.25s linear infinite; filter: blur(3px); opacity: 0.8; transform: scale(0.95); }
        
        .teaser-col { animation: teaser-spin 0.25s linear infinite; position: relative; z-index: 10; border-radius: 8px;}
        
        .slot-cell.pop { animation: pop-in 0.3s ease-out; }
        .slot-cell.win { animation: win-pulse 1s infinite; border-color: #facc15; z-index: 5; position: relative;}
        
        .mid-row-frame { position: relative; }
        .slot-col .slot-cell:nth-child(2) { background: #cbd5e1; filter: brightness(0.9); }
        .middle-frame-overlay { position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%); height: 72px; border: 2px solid rgba(167,139,250,0.6); box-shadow: 0 0 12px rgba(167,139,250,0.6); pointer-events: none; border-radius: 6px; z-index: 20;}
        .middle-frame-overlay::before { content: ""; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 14px solid rgba(250,204,21,0.9); filter: drop-shadow(0 0 6px rgba(250,204,21,0.9)); }
        .middle-frame-overlay::after { content: ""; position: absolute; right: -10px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-left: 14px solid rgba(250,204,21,0.9); filter: drop-shadow(0 0 6px rgba(250,204,21,0.9)); }
        
        .neon-text { text-shadow: 0 0 6px rgba(250,204,21,0.8), 0 0 12px rgba(250,204,21,0.6); }

        .ellipsis { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        @media (max-width: 360px) {
            .game-container { font-size: 1.1rem; }
            .slot-cell { height: 56px; }
        }
        @media (max-width: 320px) {
            .game-container { font-size: 1rem; }
            .slot-cell { height: 52px; }
        }

        .scanline {
            width: 100%; height: 100px; z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.04) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1; position: absolute; bottom: 100%;
            animation: scanline 10s linear infinite; pointer-events: none;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const WIN_GOAL = 32500;

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconBase = ({ d, color, size = 24, className = "" }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${color} ${className}`}>{d}</svg> );
        const Sword = (props) => <IconBase {...props} d={<path d="M14.5 17.5L3 6V3h3l11.5 11.5m-5-5l5 5m-5-5l5 5" />} />;
        const Shield = (props) => <IconBase {...props} d={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />} />;
        const Heart = (props) => <IconBase {...props} d={<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />} />;
        const Activity = (props) => <IconBase {...props} d={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />} />;
        const Skull = (props) => <IconBase {...props} d={<><path d="M12 2c-4.42 0-8 3.58-8 8a8.01 8.01 0 0 0 2.5 5.8l1.5 2.2H16l1.5-2.2A8.01 8.01 0 0 0 20 10c0-4.42-3.58-8-8-8z"/><path d="M9 14h6"/><path d="M15 17h.01"/><path d="M9 17h.01" /></>} />;
        const ShoppingBag = (props) => <IconBase {...props} d={<><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0" /></>} />;
        const Briefcase = (props) => <IconBase {...props} d={<><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>} />;
        const Footprints = (props) => <IconBase {...props} d={<><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-.76 2.5-2 3.5-1.24 1-2 2.25-2 3.5V17"/><path d="M14 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C8.63 6 7 7.8 7 12c0 1.25.76 2.5 2 3.5 1.24 1 2 2.25 2 3.5V21" /></>} />;
        const LogOut = (props) => <IconBase {...props} d={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12" /></>} />;
        const Radio = (props) => <IconBase {...props} d={<><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14" /></>} />;
        const Coins = (props) => <IconBase {...props} d={<><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="M17.121 17.121A3 3 0 1 0 21.364 21.364 3 3 0 1 0 17.121 17.121z" /></>} />;
        const Trash2 = (props) => <IconBase {...props} d={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17" /></>} />;
        const Utensils = (props) => <IconBase {...props} d={<><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" /></>} />;
        const Smile = (props) => <IconBase {...props} d={<><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9" /></>} />;
        const Hammer = (props) => <IconBase {...props} d={<><path d="M15 12l-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15L22 10.64"/><path d="M20.91 8.26L15.73 3.08a1 1 0 0 0-1.41 0l-1.42 1.42a1 1 0 0 0 0 1.41l5.66 5.66a1 1 0 0 0 1.41 0l1.42-1.42a1 1 0 0 0 0-1.41z" /></>} />;
        const HelpCircle = (props) => <IconBase {...props} d={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" cy="17" x2="12.01" y2="17" /></>} />;
        const Gem = (props) => <IconBase {...props} d={<path d="M6 3h12l4 6-10 13L2 9z" />} />;
        const Rocket = (props) => <IconBase {...props} d={<path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09zM12 15l-3-3m1.5 1.5l2-2M2 22l1.5-1.5M9 11l.5-.5M20 4l-4 4m1-4l3 3M15 12s-4-4-8-1l12 12c3-4-1-8-1-8z" />} />;

        // --- æ¸¸æˆæ•°æ®é…ç½® ---
        const ITEMS = {
          medkit:   { id: 'medkit', name: 'æ€¥æ•‘åŒ…', type: 'consumable', cost: 60, effect: 'heal', value: 40, desc: 'æ¢å¤40ç”Ÿå‘½', rarity: 'white' },
          food:     { id: 'food', name: 'å‹ç¼©é¥¼å¹²', type: 'consumable', cost: 30, effect: 'satiety', value: 40, desc: 'æ¢å¤40é¥±é£Ÿ', rarity: 'white' },
          alcohol:  { id: 'alcohol', name: 'é™ˆå¹´å¨å£«å¿Œ', type: 'consumable', cost: 80, effect: 'mood', value: 50, desc: 'æ¢å¤50å¿ƒæƒ…,å‡å°‘10San', rarity: 'green' },
          pills:    { id: 'pills', name: 'é•‡é™å‰‚', type: 'consumable', cost: 120, effect: 'sanity', value: 40, desc: 'æ¢å¤40ç†æ™º(San)', rarity: 'blue' },
          ammo_box: { id: 'ammo_box', name: 'è‡ªåˆ¶å¼¹è¯ç®±', type: 'consumable', cost: 0, effect: 'buff_atk', value: 10, desc: 'ä¼¤å®³+10 (åˆ¶é€ )', rarity: 'green' },
        };

        const GEAR = {
          knife:    { id: 'knife', name: 'ç”Ÿé”ˆåŒ•é¦–', type: 'weapon', cost: 0, atk: 2, desc: 'èŠèƒœäºæ— ' },
          pistol:   { id: 'pistol', name: 'æ—§æ‰‹æª', type: 'weapon', cost: 150, atk: 5, desc: 'å¯é çš„ä¼™ä¼´' },
          rifle:    { id: 'rifle', name: 'çªå‡»æ­¥æª', type: 'weapon', cost: 400, atk: 12, desc: 'ç«åŠ›å‹åˆ¶' },
          clothes:  { id: 'clothes', name: 'ä¾¿æœ', type: 'armor', cost: 0, def: 0, desc: 'ä¸é˜²å¼¹' },
          vest:     { id: 'vest', name: 'é˜²å¼¹èƒŒå¿ƒ', type: 'armor', cost: 200, def: 3, desc: 'å‡å°‘3ç‚¹ä¼¤å®³' },
          heavy:    { id: 'heavy', name: 'é‡å‹è£…ç”²', type: 'armor', cost: 500, def: 8, desc: 'ç§»åŠ¨å¦å…‹' },
        };

        const RELICS = {
          vampire:    { id: 'vampire', name: 'å¸è¡€é¬¼ä¹‹ç‰™', desc: 'å‡»æ€æ•Œäººå›å¤ 5 HP', rarity: 'purple', type: 'relic' },
          cat:        { id: 'cat', name: 'æ‹›è´¢çŒ«', desc: 'æ’¤ç¦»ç»“ç®—é‡‘å¸ +20%', rarity: 'purple', type: 'relic' },
          adrenaline: { id: 'adrenaline', name: 'è‚¾ä¸Šè…ºç´ ', desc: 'HP < 30% æ—¶æ”»å‡»åŠ›ç¿»å€', rarity: 'purple', type: 'relic' },
        };

        const FACILITIES = {
          medical:   { id: 'medical', name: 'æˆ˜åœ°åŒ»ç–—ç«™', cost: { 'èºä¸ç»„ä»¶': 10, 'åºŸæ—§é’¢æ': 5 }, desc: 'æ’¤ç¦»åè‡ªåŠ¨æ¢å¤ç¿»å€' },
          workbench: { id: 'workbench', name: 'ç²¾å¯†å·¥ä½œå°', cost: { 'çº¿æç»„ä»¶': 5, 'è“„ç”µæ± ': 1 }, desc: 'è§£é”å¼¹è¯åˆ¶é€ ' },
          kitchen:   { id: 'kitchen', name: 'é‡æˆ˜å¨æˆ¿', cost: { 'ç¥ç§˜è‚‰ç½å¤´': 3 }, desc: 'é¥±é£Ÿåº¦ä¸Šé™ +50' },
        };

        const STORY_EVENTS = [
          {
            id: 'injured_scavenger', text: 'ä½ å‘ç°ä¸€ä¸ªå—ä¼¤çš„æ‹¾è’è€…é åœ¨å¢™è¾¹ï¼Œè…¹éƒ¨çš„ä¼¤å£æ­£åœ¨æ¸—è¡€ã€‚',
            choices: [
              { id: 'help', text: 'æ•‘åŠ© (æ¶ˆè€—æ€¥æ•‘åŒ…)', req: { item: 'medkit' }, resultText: 'ä½ åŒ…æ‰äº†ä»–çš„ä¼¤å£ã€‚ä»–æ„Ÿæ¿€åœ°å¡ç»™ä½ ä¸€äº›ä¸œè¥¿ã€‚', mood: 20, sanity: 5, lootChance: 1.0 },
              { id: 'rob', text: 'æ‰“åŠ«', resultText: 'ä½ è¶ç«æ‰“åŠ«ã€‚ä»–è¯•å›¾åæŠ—...', combat: true, enemyId: 'weak_scavenger', mood: -10, sanity: -10 },
              { id: 'ignore', text: 'æ— è§†', resultText: 'ä½ ä»ä»–èº«è¾¹èµ°è¿‡ï¼Œå‡è£…æ²¡å¬è§ä»–çš„å‘»åŸã€‚', mood: -5, sanity: -2 }
            ]
          },
          {
            id: 'abandoned_shrine', text: 'åºŸå¢Ÿæ·±å¤„æœ‰ä¸€åº§å †æ»¡ç”µå­å…ƒä»¶çš„å¥‡æ€ªç¥­å›ï¼Œæ•£å‘ç€å¾®å…‰ã€‚',
            choices: [
              { id: 'pray', text: 'ç¥ˆç¥· (æ¶ˆè€—5é¥±é£Ÿ)', req: { stat: 'satiety', val: 5 }, resultText: 'ä½ æ„Ÿåˆ°ä¸€é˜µå¹³é™ï¼Œä½†ä¹Ÿæ›´åŠ é¥¥é¥¿ã€‚', mood: 10, sanity: 20 },
              { id: 'desecrate', text: 'æœåˆ®ç¥­å›', resultText: 'ä½ æ‹¿èµ°äº†ä¸Šé¢çš„é›¶ä»¶ï¼Œä½†æ„Ÿè§‰æœ‰ä»€ä¹ˆä¸œè¥¿è·Ÿä¸Šäº†ä½ ...', combat: true, enemyId: 'glitch', mood: 0, sanity: -15, lootChance: 1.0 },
              { id: 'leave', text: 'ç¦»å¼€', resultText: 'ä¸ä½œæ­»å°±ä¸ä¼šæ­»ã€‚', mood: 0, sanity: 0 }
            ]
          }
        ];

        const RARITY_CONFIG = {
          white:   { label: 'æ™®é€š', color: 'text-slate-400', border: 'border-slate-500', bg: 'bg-slate-800' },
          green:   { label: 'ä¼˜è‰¯', color: 'text-emerald-400', border: 'border-emerald-500', bg: 'bg-emerald-900/20' },
          blue:    { label: 'ç¨€æœ‰', color: 'text-cyan-400', border: 'border-cyan-500', bg: 'bg-cyan-900/20' },
          purple:  { label: 'å²è¯—', color: 'text-fuchsia-400', border: 'border-fuchsia-500', bg: 'bg-fuchsia-900/20' },
          gold:    { label: 'ä¼ è¯´', color: 'text-amber-400', border: 'border-amber-500', bg: 'bg-amber-900/20' },
          special: { label: 'ç‰¹æ®Š', color: 'text-red-500 animate-pulse', border: 'border-red-500', bg: 'bg-red-900/20' },
        };

        const LOOT_DB = [
          { name: 'èºä¸ç»„ä»¶', val: 15, rarity: 'white', type: 'loot' }, { name: 'åºŸæ—§é’¢æ', val: 25, rarity: 'white', type: 'loot' },
          { name: 'ç¥ç§˜è‚‰ç½å¤´', val: 30, rarity: 'white', type: 'loot' }, { name: 'ç²—ç³™å¸ƒæ–™', val: 50, rarity: 'green', type: 'loot' },
          { name: 'çº¿æç»„ä»¶', val: 65, rarity: 'green', type: 'loot' }, { name: 'æœªçŸ¥é…±æ–™', val: 80, rarity: 'green', type: 'loot' },
          { name: 'å¥½ç”¨çš„é’³å­', val: 150, rarity: 'blue', type: 'loot' }, { name: 'æ¶¦æ»‘æ²¹', val: 180, rarity: 'blue', type: 'loot' },
          { name: 'ç‡ƒæ°”ç“¶', val: 220, rarity: 'blue', type: 'loot' }, { name: 'ä¼˜è´¨é’¢æ', val: 400, rarity: 'purple', type: 'loot' },
          { name: 'è“„ç”µæ± ', val: 550, rarity: 'purple', type: 'loot' }, { name: 'ç«è¯', val: 600, rarity: 'purple', type: 'loot' },
          { name: 'æ±‚ç”Ÿæ€¥æ•‘åŒ…', val: 1000, rarity: 'gold', type: 'loot' }, { name: 'å®Œæ•´æŠ—ç”Ÿç´ ', val: 1200, rarity: 'gold', type: 'loot' },
          { name: 'æ±‚ç”Ÿæ— çº¿ç”µå‘å°„å™¨', val: 5000, rarity: 'special', type: 'loot' },
          { ...RELICS.vampire, val: 800 }, { ...RELICS.cat, val: 800 }, { ...RELICS.adrenaline, val: 800 },
        ];

        const EXCHANGE_ASSETS = [
          { id: 'gold', name: 'é‡å­é»„é‡‘', price: 100, vol: 0.02, held: 0, change: 0, costBasis: 0 },
          { id: 'realty', name: 'æœ«æ—¥åœ°äº§', price: 80, vol: 0.05, held: 0, change: 0, costBasis: 0 },
          { id: 'space', name: 'æ…ˆå–„èˆªå¤©', price: 50, vol: 0.20, held: 0, change: 0, costBasis: 0 },
          { id: 'wtc', name: 'åŠ å¯†ç¡¬å¸WTC', price: 10, vol: 0.50, held: 0, change: 0, costBasis: 0 },
        ];

        const EXCHANGE_NEWS_POOL = [
          { text: 'å¤©é¡¶æ˜Ÿèˆªå¤©å®£å¸ƒå‘ç°å¤–æ˜Ÿå¯ä¹ç§˜æ–¹ï¼Œè‚¡ä»·æš´æ¶¨ 40%ï¼', targetId: 'space', effect: 0.40 },
          { text: 'æŸé»‘å®¢å£°ç§°åˆ åº“è·‘è·¯ï¼ŒåºŸåœŸå¸ç¬é—´è’¸å‘ 80%ã€‚', targetId: 'wtc', effect: -0.80 },
          { text: 'é‡‘åº“åŠ å›ºå®Œæˆï¼Œé¿éš¾æ‰€é»„é‡‘ä¹°ç›˜å¢å¼ºï¼Œç¨³ä¸­æœ‰å‡ 5%ã€‚', targetId: 'gold', effect: 0.05 },
          { text: 'åŸé˜²å‡çº§å»¶æœŸï¼Œåœ°äº§æ¿å—æ‰¿å‹ 10%ã€‚', targetId: 'realty', effect: -0.10 },
        ];
        const EXCHANGE_FEE_RATE = 0.02;

        const ENEMIES = [
          { id: 'rat', name: 'å˜å¼‚è€é¼ ', hp: 10, atk: 3, exp: 10 }, { id: 'scavenger', name: 'æµæµªæ‹¾è’è€…', hp: 25, atk: 6, exp: 30 },
          { id: 'thug', name: 'æ­¦è£…æš´å¾’', hp: 45, atk: 10, exp: 60 }, { id: 'merc', name: 'ç²¾è‹±ä½£å…µ', hp: 80, atk: 15, exp: 150 },
        ];

        // --- æ ·å¼ç»„ä»¶ ---
        const PixelCard = ({ children, className = "", onClick, disabled }) => (
          <div 
            onClick={!disabled ? onClick : undefined}
            className={`
              relative border-2 border-slate-600 bg-slate-800 p-3 
              shadow-[2px_2px_0px_0px_rgba(0,0,0,0.8)] 
              active:shadow-none active:translate-y-[2px] active:translate-x-[2px]
              transition-all cursor-pointer select-none text-slate-200
              ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : 'hover:bg-slate-700 hover:border-slate-400'}
              ${className}
            `}
          >
            {children}
          </div>
        );

        const ProgressBar = ({ current, max, color = "bg-green-600", label, icon }) => (
          <div className="flex items-center gap-1 text-sm leading-none mb-1 pixel-font w-full">
            {icon && <span className="w-4 text-slate-400">{icon}</span>}
            <div className="flex-1 h-2 bg-slate-900 border border-slate-600 relative">
              <div className={`h-full ${color} transition-all duration-300`} style={{ width: `${Math.max(0, Math.min(100, (current / max) * 100))}%` }} />
            </div>
          </div>
        );

        // =========================================
        // æ ¸å¿ƒå­ç»„ä»¶ï¼šè€è™æœºé¢æ¿
        // =========================================
        const SlotMachine5x3 = ({ bet, onSpin, isSpinning, result, moodMsg, jackpots, energy, isFrenzy, freeSpins, frenzySpins, teaserCol, winningPositions, bannerText, bannerBoost, isVipMode, energyCap }) => {
            const moodColor = moodMsg && moodMsg.includes('+') ? 'text-green-400' : moodMsg && moodMsg.includes('-') ? 'text-red-400' : 'text-purple-400';
            const [animCols, setAnimCols] = useState([false,false,false,false,false]);
            const [displayGrid, setDisplayGrid] = useState(Array.from({length:3},()=>Array.from({length:5},()=> 'â“')));
            const spinTimers = useRef([null,null,null,null,null]);
            const [popCells, setPopCells] = useState(new Set());
            const [activeTeaser, setActiveTeaser] = useState(null);

            // åŸºäºä¸‹æ³¨å†³å®šéšæœºåŠ¨ç”»æ± ï¼šè¿™åªæ˜¯è§†è§‰æ•ˆæœï¼Œé€»è¾‘åœ¨ä¸»ç»„ä»¶ä¸­
            const randPick = () => {
                let pool = ['ğŸ’€','ğŸ”§','ğŸ—','â˜¢ï¸','ğŸ’','7ï¸âƒ£','ğŸƒ','â­'];
                if (!isVipMode) {
                    if (bet < 100) pool = ['ğŸ’€','ğŸ”§','ğŸ—','â˜¢ï¸','ğŸ’','7ï¸âƒ£','ğŸƒ'];
                }
                return pool[Math.floor(Math.random()*pool.length)];
            };

            const startSpinAnim = (c) => {
                setAnimCols(prev => { const p=[...prev]; p[c]=true; return p; });
                spinTimers.current[c] = setInterval(() => {
                    setDisplayGrid(prev => {
                        const next = prev.map(row => [...row]);
                        for (let r=0;r<3;r++) next[r][c] = randPick();
                        return next;
                    });
                }, 50);
            };

            const stopSpinAnim = (c, finalCol) => {
                if (spinTimers.current[c]) { clearInterval(spinTimers.current[c]); spinTimers.current[c]=null; }
                setAnimCols(prev => { const p=[...prev]; p[c]=false; return p; });
                setDisplayGrid(prev => {
                    const next = prev.map(row => [...row]);
                    for (let r=0;r<3;r++) next[r][c] = finalCol[r];
                    return next;
                });
                
                setPopCells(prev => {
                    const next = new Set(prev);
                    for (let r=0;r<3;r++) next.add(`${r}-${c}`);
                    return next;
                });

                setTimeout(() => {
                    setPopCells(prev => {
                        const next = new Set(prev);
                        for (let r=0;r<3;r++) next.delete(`${r}-${c}`);
                        return next;
                    });
                }, 300);
            };

            useEffect(() => {
                if (isSpinning) {
                    for (let c=0;c<5;c++) startSpinAnim(c);
                } else {
                    for (let c=0;c<5;c++) { if (spinTimers.current[c]) { clearInterval(spinTimers.current[c]); spinTimers.current[c]=null; } }
                    setAnimCols([false,false,false,false,false]);
                    setActiveTeaser(null);
                }
                return () => { for (let c=0;c<5;c++) { if (spinTimers.current[c]) { clearInterval(spinTimers.current[c]); spinTimers.current[c]=null; } } };
            }, [isSpinning]);

            useEffect(() => {
                if (isSpinning && result) {
                    (async () => {
                        let scatterCountSoFar = 0;
                        for (let c=0;c<5;c++) {
                            let baseDelay = c===0 ? 500 : 300;
                            if (c===4 && teaserCol===4 && scatterCountSoFar===2) {
                                baseDelay = 2000;
                                setActiveTeaser(4); 
                            }
                            await new Promise(r => setTimeout(r, baseDelay));
                            
                            if (spinTimers.current[c]) {
                                const finalCol = [result[0][c], result[1][c], result[2][c]];
                                stopSpinAnim(c, finalCol);
                                if (c === 4) setActiveTeaser(null);
                                scatterCountSoFar += finalCol.filter(s=>s==='â­').length;
                            }
                        }
                    })();
                }
            }, [isSpinning, result, teaserCol]);

            return (
                <div className={`bg-slate-900 p-3 border-4 ${isVipMode ? 'border-red-600 shadow-[0_0_20px_rgba(220,38,38,0.5)]' : 'border-yellow-600'} rounded-lg text-center mb-2 relative overflow-hidden ${isFrenzy ? 'fever-mode' : ''}`}>
                    <div className={`absolute inset-0 ${isVipMode ? 'bg-red-900/10' : 'bg-yellow-900/10'} pointer-events-none`}></div>
                    
                    {bannerText && (
                        <div className={`absolute inset-0 z-[100] flex items-center justify-center pointer-events-none transition-transform duration-300 ${bannerBoost ? 'scale-110' : 'scale-100'}`}>
                            <span className="text-3xl font-bold text-yellow-400 neon-text bg-black/80 px-4 py-2 rounded-lg border-2 border-yellow-500 shadow-[0_0_20px_#ca8a04] max-w-[90%] break-words whitespace-normal leading-snug">
                                {bannerText}
                            </span>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-2 px-1 relative z-10">
                        <div className="text-left"><div className="text-[10px] text-amber-400 font-bold uppercase">MINI</div><div className="text-lg text-amber-300 font-bold leading-none">${jackpots.mini.toLocaleString()}</div></div>
                        <div className="text-center"><div className="text-[10px] text-amber-500 font-bold uppercase">MAJOR</div><div className="text-xl text-amber-400 font-bold leading-none">${jackpots.major.toLocaleString()}</div></div>
                        <div className="text-right"><div className="text-[10px] text-amber-600 font-bold uppercase">GRAND</div><div className="text-2xl text-amber-500 font-bold leading-none">${jackpots.grand.toLocaleString()}</div></div>
                    </div>
                    <div className="mb-2 flex justify-between items-center px-1 relative z-10"><div className="text-[10px] text-purple-300">ENERGY {energy}/{energyCap}</div><div className="text-[10px] text-purple-300">FS {freeSpins} / RF {frenzySpins}</div></div>
                    
                    <div className="relative bg-black/40 p-2 rounded z-10">
                        <div className="middle-frame-overlay"></div>
                        <div className="slot-grid mid-row-frame">
                        {[0,1,2,3,4].map(c => (
                            <div key={c} id={`col-${c}`} className={`slot-col ${activeTeaser === c ? 'teaser-col' : (animCols[c] ? 'text-blur-out' : '')}`}>
                                {[0,1,2].map(r => {
                                    const val = displayGrid?.[r]?.[c] || 'â“';
                                    const win = winningPositions?.some(w => w[0]===r && w[1]===c);
                                    const pop = popCells.has(`${r}-${c}`);
                                    return (<div key={r} id={`cell-${c}-${r}`} className={`slot-cell ${pop ? 'pop' : ''} ${win ? 'win' : ''}`}>{val}</div>);
                                })}
                            </div>
                        ))}
                        </div>
                    </div>
                    <button onClick={onSpin} disabled={isSpinning} className={`w-full mt-3 py-3 text-xl font-bold rounded border-b-4 active:border-b-0 active:translate-y-1 transition-all relative z-10 ${isSpinning ? 'bg-slate-600 border-slate-800 text-slate-400' : isFrenzy || frenzySpins>0 ? 'bg-purple-600 border-purple-800 hover:bg-purple-500 text-white animate-pulse' : 'bg-red-600 border-red-800 hover:bg-red-500 text-white'}`}>{isSpinning ? 'SPINNING...' : (freeSpins>0 ? 'FREE SPIN!' : (frenzySpins>0 ? 'RADIATION FRENZY!' : `PULL LEVER ($${bet})`))}</button>
                    {moodMsg && (<div className={`mt-2 text-sm relative z-10 ${moodColor}`}>{moodMsg}</div>)}
                </div>
            );
        };

        // =========================================
        // ä¸»ç»„ä»¶
        // =========================================
        function ExtractionGame() {
          const [scene, setScene] = useState('intro');
          const [logs, setLogs] = useState([]);
          const [confirmId, setConfirmId] = useState(null); 
          const [isShake, setIsShake] = useState(false);
          
          const [shopTab, setShopTab] = useState('buy');
          const [betAmount, setBetAmount] = useState(50);
          const [isVipMode, setIsVipMode] = useState(false);
          const [showCasinoRules, setShowCasinoRules] = useState(false);
          
          const [isSpinning, setIsSpinning] = useState(false);
          const [spinCount, setSpinCount] = useState(0);
          const [freeSpins, setFreeSpins] = useState(0);
          const [slotMoodMsg, setSlotMoodMsg] = useState('');
          
          const [jackpots, setJackpots] = useState({ mini: 2000, major: 8000, grand: 20000 });
          const [energy, setEnergy] = useState(0);
          const ENERGY_CAP = 42;
          const [isFrenzy, setIsFrenzy] = useState(false);
          const [frenzySpins, setFrenzySpins] = useState(0);
          const [slotGrid, setSlotGrid] = useState(null);
          const [winningPositions, setWinningPositions] = useState([]);
          const [teaserCol, setTeaserCol] = useState(null);
          const JACKPOT_BASES = { mini: 2000, major: 8000, grand: 20000 };
          const [slotBanner, setSlotBanner] = useState('');
          const [bannerBoost, setBannerBoost] = useState(false);
          const [exchangeAssets, setExchangeAssets] = useState(EXCHANGE_ASSETS.map(a => ({...a})));
          const [exchangeNews, setExchangeNews] = useState(null);
          const [exchangeLastDay, setExchangeLastDay] = useState(null);
          const [selectedAssetId, setSelectedAssetId] = useState(EXCHANGE_ASSETS[0].id);
          const [buyQty, setBuyQty] = useState(1);
          const [sellQty, setSellQty] = useState(1);

          // Intro State
          const [introStep, setIntroStep] = useState(0);
          const introEndRef = useRef(null); 
          const introTexts = [
              "é™¤å¤•ä¹‹å¤œï¼Œå†™å­—æ¥¼çš„ç¯å…‰æƒ¨ç™½ä¾æ—§ã€‚",
              "ä½ åˆšåˆšæäº¤äº†æœ€åä¸€è¡Œä»£ç ï¼Œæ­£å‡†å¤‡è¿æ¥ä¹…è¿çš„å‡æœŸã€‚",
              "æ¨å¼€å¤§é—¨çš„ç¬é—´ï¼Œä¸€é˜µä¸å±äºè¿™ä¸ªå­£èŠ‚çš„åˆºéª¨å¯’é£å°†ä½ åæ²¡â€¦â€¦",
              "å†ççœ¼æ—¶ï¼Œç†Ÿæ‚‰çš„è¡—é“å·²æˆç„¦åœŸã€‚",
              "è§†ç½‘è†œä¸Šè·³åŠ¨ç€å¹½ç»¿è‰²çš„ä¹±ç ï¼Œæœ€ç»ˆæ±‡èšæˆä¸€ä¸ªå¤å¤çš„æ¸¸æˆç•Œé¢ã€‚",
              "ã€ç³»ç»Ÿå¯åŠ¨â€¦â€¦åºŸåœŸç”Ÿå­˜åè®®å·²åŠ è½½ã€‘",
              "ã€æ³¨æ„ï¼šæ£€æµ‹åˆ°é»‘å¸‚æ§åˆ¶æƒå·²è¢«ä¸æ˜è´¢å›¢æŒæ§ã€‘",
              "ã€ç›®æ ‡æ›´æ–°ï¼šç¼´çº³ $32,500 æ¿€æ´»æ’¤ç¦»é£èˆ¹ï¼Œè¿”å›ç°å®ä¸–ç•Œã€‘",
              "åœ¨è¿™ä¸ªç»æœ›çš„ä¸–ç•Œï¼Œé‡‘é’±å°±æ˜¯ä½ å”¯ä¸€çš„å½’é€”ã€‚",
              "æ´»ä¸‹å»ï¼Œæˆ–è€…æˆä¸ºæ•°æ®çš„ä¸€éƒ¨åˆ†ã€‚"
          ];

          const [player, setPlayer] = useState({
            hp: 100, maxHp: 100, satiety: 100, maxSatiety: 100,
            mood: 100, maxMood: 100, sanity: 100, maxSanity: 100,
            money: 500, weapon: GEAR.knife, armor: GEAR.clothes,
            relics: [], facilities: {}, inventory: [], storage: [],
          });

          const [raidState, setRaidState] = useState({
            distance: 0, dangerLevel: 1, currentEnemy: null, isGlitchEnemy: false,
            tempLoot: [], currentLootItem: null, currentInteractiveEvent: null,
          });

          const addLog = (msg, type = 'neutral') => {
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            setLogs(prev => [`[${time}] ${msg}`, ...prev].slice(0, 8));
          };

          const triggerShake = () => { setIsShake(true); setTimeout(() => setIsShake(false), 500); };
          const countItemInStorage = (itemName) => player.storage.filter(i => i.name === itemName).length;
          const removeItemsFromStorage = (itemName, count) => { let removed = 0; return player.storage.filter(item => { if (item.name === itemName && removed < count) { removed++; return false; } return true; }); };

          const upgradeFacility = (facId) => {
            const facility = FACILITIES[facId]; if (player.facilities[facId]) return;
            let canBuild = true; for (const [name, count] of Object.entries(facility.cost)) { if (countItemInStorage(name) < count) canBuild = false; }
            if (canBuild) {
              let newStorage = [...player.storage];
              for (const [name, count] of Object.entries(facility.cost)) { let removed = 0; newStorage = newStorage.filter(item => { if (item.name === name && removed < count) { removed++; return false; } return true; }); }
              const newFacilities = { ...player.facilities, [facId]: true };
              let updates = { storage: newStorage, facilities: newFacilities };
              if (facId === 'kitchen') { updates.maxSatiety = 150; updates.satiety = 150; }
              setPlayer(prev => ({ ...prev, ...updates })); addLog(`è®¾æ–½å»ºé€ æˆåŠŸï¼š${facility.name}`, 'success');
            } else { addLog('ææ–™ä¸è¶³ï¼Œæ— æ³•å»ºé€ ï¼', 'error'); }
          };

          const craftAmmo = () => {
            const costMoney = 50; const material = 'åºŸæ—§é’¢æ';
            if (player.money >= costMoney && countItemInStorage(material) >= 1) {
              const newStorage = removeItemsFromStorage(material, 1);
              setPlayer(prev => ({ ...prev, money: prev.money - costMoney, storage: [...newStorage, { ...ITEMS.ammo_box, type: 'consumable' }] }));
              addLog('åˆ¶é€ äº† è‡ªåˆ¶å¼¹è¯ç®±', 'success');
            } else { addLog('åˆ¶é€ ææ–™æˆ–èµ„é‡‘ä¸è¶³ ($50 + åºŸæ—§é’¢æ)', 'error'); }
          };

          const settleExchange = () => {
            const day = Math.floor(raidState.distance / 1000) + 1;
            if (exchangeLastDay !== null && day === exchangeLastDay) return;
            const news = EXCHANGE_NEWS_POOL[Math.floor(Math.random() * EXCHANGE_NEWS_POOL.length)];
            setExchangeNews(news);
            setExchangeAssets(prev => prev.map(a => {
              let delta = (Math.random() * 2 - 1) * a.vol;
              if (a.id === 'realty') { delta += (a.change || 0) > 0 ? 0.02 : (a.change || 0) < 0 ? -0.02 : 0; }
              if (news && news.targetId === a.id) { delta += news.effect; }
              const np = Math.max(1, Math.floor(a.price * (1 + delta)));
              const ch = Math.round(delta * 1000) / 10;
              return { ...a, price: np, change: ch };
            }));
            setExchangeLastDay(day);
          };

          const buyAsset = (id, qty) => {
            const asset = exchangeAssets.find(a => a.id === id);
            if (!asset) return;
            const cost = asset.price * qty;
            const fee = Math.floor(cost * EXCHANGE_FEE_RATE);
            const totalCost = cost + fee;
            if (qty <= 0 || player.money < totalCost) { addLog('èµ„é‡‘ä¸è¶³ï¼', 'error'); return; }
            setPlayer(p => ({ ...p, money: p.money - totalCost }));
            setExchangeAssets(prev => prev.map(a => {
              if (a.id !== id) return a;
              const newHeld = a.held + qty;
              const newBasis = newHeld > 0 ? (((a.costBasis || 0) * a.held) + totalCost) / newHeld : 0;
              return { ...a, held: newHeld, costBasis: newBasis };
            }));
            addLog(`ğŸ“ˆ ä¹°å…¥ ${asset.name} ${qty} ä»½ï¼ŒèŠ±è´¹ $${cost}ï¼ˆæ‰‹ç»­è´¹ $${fee}ï¼‰`, 'success');
          };

          const sellAsset = (id, qty) => {
            const asset = exchangeAssets.find(a => a.id === id);
            if (!asset || asset.held <= 0) { addLog('æ— å¯å–å‡ºçš„æŒä»“ã€‚', 'error'); return; }
            const sellQtyFinal = Math.min(qty, asset.held);
            if (sellQtyFinal <= 0) { addLog('å–å‡ºæ•°é‡æ— æ•ˆã€‚', 'error'); return; }
            const revenue = asset.price * sellQtyFinal;
            const fee = Math.floor(revenue * EXCHANGE_FEE_RATE);
            const netRevenue = Math.max(0, revenue - fee);
            const pnl = Math.round((asset.price - (asset.costBasis || 0)) * sellQtyFinal - fee);
            setPlayer(p => ({ ...p, money: p.money + netRevenue }));
            setExchangeAssets(prev => prev.map(a => {
              if (a.id !== id) return a;
              const remaining = a.held - sellQtyFinal;
              return { ...a, held: remaining, costBasis: remaining > 0 ? a.costBasis : 0 };
            }));
            addLog(`ğŸ’° å–å‡º ${asset.name} ${sellQtyFinal} ä»½ï¼Œæ”¶å…¥ $${netRevenue}ï¼ˆæ‰‹ç»­è´¹ $${fee}ï¼‰ï¼Œç›ˆäº $${pnl}`, pnl >= 0 ? 'success' : 'error');
          };

          const sellAssetAll = (id) => {
            const asset = exchangeAssets.find(a => a.id === id);
            if (!asset || asset.held <= 0) { addLog('æ— å¯æ¸…ä»“çš„æŒä»“ã€‚', 'error'); return; }
            const revenue = asset.price * asset.held;
            const fee = Math.floor(revenue * EXCHANGE_FEE_RATE);
            const netRevenue = Math.max(0, revenue - fee);
            const pnl = Math.round((asset.price - (asset.costBasis || 0)) * asset.held - fee);
            setPlayer(p => ({ ...p, money: p.money + netRevenue }));
            setExchangeAssets(prev => prev.map(a => a.id === id ? { ...a, held: 0, costBasis: 0 } : a));
            addLog(`ğŸ“‰ æ¸…ä»“ ${asset.name}ï¼Œæ”¶å…¥ $${netRevenue}ï¼ˆæ‰‹ç»­è´¹ $${fee}ï¼‰ï¼Œç›ˆäº $${pnl}`, pnl >= 0 ? 'success' : 'error');
          };

          useEffect(() => { if (shopTab === 'exchange') settleExchange(); }, [shopTab, raidState.distance]);

          const handleEventChoice = (choice) => {
            if (choice.req) {
              if (choice.req.item) { const hasItem = player.storage.some(i => i.id === choice.req.item); if (!hasItem) { addLog('ç¼ºå°‘æ‰€éœ€ç‰©å“ï¼', 'error'); return; } const idx = player.storage.findIndex(i => i.id === choice.req.item); const newStorage = player.storage.filter((_, i) => i !== idx); setPlayer(prev => ({ ...prev, storage: newStorage })); }
              if (choice.req.stat) { if (player[choice.req.stat] < choice.req.val) { addLog('çŠ¶æ€ä¸è¶³ï¼', 'error'); return; } setPlayer(prev => ({ ...prev, [choice.req.stat]: prev[choice.req.stat] - choice.req.val })); }
            }
            addLog(choice.resultText);
            if (choice.mood) setPlayer(prev => ({ ...prev, mood: Math.min(prev.maxMood, prev.mood + choice.mood) }));
            if (choice.sanity) setPlayer(prev => ({ ...prev, sanity: Math.min(prev.maxSanity, prev.sanity + choice.sanity) }));
            if (choice.combat) { let enemyTemplate = ENEMIES[0]; if (choice.enemyId === 'weak_scavenger') enemyTemplate = { name: 'å—ä¼¤çš„æ‹¾è’è€…', hp: 15, atk: 4, exp: 20 }; if (choice.enemyId === 'glitch') enemyTemplate = { name: '?%#ERROR', hp: 60, atk: 12, exp: 0 }; setRaidState(prev => ({ ...prev, currentEnemy: { ...enemyTemplate, maxHp: enemyTemplate.hp }, isGlitchEnemy: choice.enemyId === 'glitch' })); setScene('combat'); return; }
            if (choice.lootChance) { if (Math.random() < choice.lootChance) { const loot = generateLootItem(raidState.distance + 500); setRaidState(prev => ({ ...prev, tempLoot: [...prev.tempLoot, loot], currentLootItem: loot })); setScene('event'); return; } }
            setScene('raid');
          };

          const handleShopClick = (item, type) => {
            const key = item.id || item.name;
            if (confirmId === key) {
              if (type === 'gear') buyGear(item); 
              else if (type === 'material') buyMaterial(item);
              else buyItem(item);
              setConfirmId(null);
            } else {
              setConfirmId(key);
              setTimeout(() => { setConfirmId(prev => prev === key ? null : prev); }, 3000);
            }
          };

          // ==========================================
          // ä¿®å¤åä¸”å‡†ç¡®åŒæ­¥åŠ¨ç”»æ—¶é—´è½´çš„è€èµŒæœºæ´¾å½©é€»è¾‘
          // ==========================================
          const handleSpin5x3 = () => {
              const isFreeSpin = freeSpins > 0; const isFrenzySpin = frenzySpins > 0;
              const inSpecialMode = isFreeSpin || isFrenzySpin || isFrenzy;

              if (!isFreeSpin && !isFrenzySpin && player.money < betAmount) { addLog("èµ„é‡‘ä¸è¶³ï¼", "error"); return; }
              
              if (!isFreeSpin && !isFrenzySpin) {
                  setPlayer(p => ({ ...p, money: p.money - betAmount }));
                  setJackpots(prev => ({ mini: prev.mini + Math.floor(betAmount * 0.05), major: prev.major + Math.floor(betAmount * 0.03), grand: prev.grand + Math.floor(betAmount * 0.02) }));
                  setSpinCount(prev => prev + 1);
              } else if (isFreeSpin) { setFreeSpins(prev => Math.max(0, prev - 1)); } else if (isFrenzySpin) { setFrenzySpins(prev => Math.max(0, prev - 1)); }
              
              setIsSpinning(true); setSlotGrid(null); setSlotMoodMsg(''); setWinningPositions([]); setTeaserCol(null); setSlotBanner(''); setBannerBoost(false);
              
              // ------------------------------------------
              // æ ¸å¿ƒæœºåˆ¶ï¼šåŸºäºæ³¨é¢çš„åˆ†å±‚å¥–æ± 
              // ------------------------------------------
              const poolNormal = [{s:'ğŸ’€',w:20},{s:'ğŸ”§',w:25},{s:'ğŸ—',w:20},{s:'â˜¢ï¸',w:15},{s:'ğŸ’',w:10},{s:'7ï¸âƒ£',w:4},{s:'ğŸƒ',w:4},{s:'â­',w:2}];
              const poolVip = [{s:'ğŸ’€',w:35},{s:'ğŸ”§',w:10},{s:'ğŸ—',w:10},{s:'â˜¢ï¸',w:15},{s:'ğŸ’',w:15},{s:'7ï¸âƒ£',w:8},{s:'ğŸƒ',w:4},{s:'â­',w:3}];
              
              // ç¡®å®šåˆå§‹åŸºç¡€æ± 
              let baseSymbols = isVipMode ? poolVip : poolNormal;

              // é VIP æ—¶ï¼Œä¸‹æ³¨æœªè¾¾ 100 ä¸€å¾‹ç¦ç”¨ â­
              if (!isVipMode && betAmount < 100) {
                  baseSymbols = baseSymbols.filter(x => x.s !== 'â­');
              }

              // åº”ç”¨ç‹‚çƒ­æ¨¡å¼è¿‡æ»¤ (å‰”é™¤åƒåœ¾)
              const pool = (isFrenzy || isFrenzySpin) ? baseSymbols.filter(x => x.s!=='ğŸ’€' && x.s!=='ğŸ”§') : baseSymbols;
              
              // å¦‚æœå› ä¸ºåŒé‡è¿‡æ»¤å¯¼è‡´æ± å­ç©ºäº†ï¼ˆç†è®ºä¸Šä¸ä¼šï¼Œå› ä¸ºè‡³å°‘æœ‰ğŸ—ï¼‰ï¼Œä¿åº•åŠ ä¸€ä¸ªğŸ”§
              if (pool.length === 0) pool.push({s:'ğŸ”§', w:100});

              const pick = () => { const total = pool.reduce((a,b)=>a+b.w,0); let r = Math.random()*total; for (let i=0;i<pool.length;i++){ r -= pool[i].w; if (r<=0) return pool[i].s; } return pool[pool.length-1].s; };
              
              const grid = Array.from({length:3},()=>Array.from({length:5},()=>pick()));
              const lines = [ [0,0,0,0,0],[1,1,1,1,1],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2],[0,0,1,2,2],[2,2,1,0,0],[1,0,1,2,1],[1,2,1,0,1],[0,1,1,1,2] ];
              const mul = { '7ï¸âƒ£': {3:80,4:250,5:1000}, 'ğŸ’': {3:40,4:100,5:500}, 'â˜¢ï¸': {3:20,4:50,5:200}, 'ğŸ—': {3:10,4:30,5:100}, 'ğŸ”§': {3:5,4:15,5:50} };
              const wildEnabled = isVipMode || betAmount >= 50;
              const allowed = new Set(['ğŸ”§']);
              if (isVipMode || betAmount >= 50) { allowed.add('ğŸ—'); allowed.add('â˜¢ï¸'); }
              if (isVipMode || betAmount >= 100) { allowed.add('ğŸ’'); allowed.add('7ï¸âƒ£'); }
              
              let totalMult = 0; let energyGain = 0; let miniWin=false, majorWin=false, grandWin=false; const wins=[]; let winningLines=0;
              
              for (let li=0; li<lines.length; li++) {
                  const seq = [grid[lines[li][0]][0], grid[lines[li][1]][1], grid[lines[li][2]][2], grid[lines[li][3]][3], grid[lines[li][4]][4]];
                  let base = null; for (let c=0;c<5;c++){ const sym=seq[c]; if (sym!=='ğŸƒ' && sym!=='â­' && sym!=='ğŸ’€') { base=sym; break; } }
                  if (!base) continue; if (!mul[base]) continue; if (!allowed.has(base)) continue;
                  
                  let len=0; let tempWins=[];
                  for (let c=0;c<5;c++){ const sym=seq[c]; if (sym==='â­' || sym==='ğŸ’€') break; if (sym===base || (wildEnabled && sym==='ğŸƒ')) { len++; tempWins.push([lines[li][c], c]); } else break; }
                  
                  if (len>=3) { 
                      wins.push(...tempWins);
                      totalMult += mul[base][len] || 0; 
                      winningLines += 1;
                      
                      // ç‹‚çƒ­æ¨¡å¼ä¸­ä¸è®¡å…¥å……èƒ½
                      if (!(isFrenzy || isFrenzySpin)) {
                          energyGain += (len===3?1:len===4?2:3); 
                      }
                      
                      if (len===5) { if (base==='â˜¢ï¸') miniWin=true; if (base==='ğŸ’') majorWin=true; if (base==='7ï¸âƒ£') grandWin=true; } 
                  }
              }
              
              const scatters = grid.flat().filter(s=>s==='â­').length;
              const teaser = scatters >=2 && [0,1,2,3].some(c => [0,1,2].some(r => grid[r][c]==='â­')) ? 4 : null; 
              
              setTeaserCol(teaser);
              setSlotGrid(grid);
              
              const baseDelay = teaser === 4 ? 3700 : 2000;
              
              if (teaser === 4) {
                  setTimeout(() => {
                      setSlotBanner('å³å°†å‡ºå…è´¹æ‘‡å¥–...ï¼Ÿï¼ï¼');
                      setBannerBoost(true);
                      setTimeout(() => setBannerBoost(false), 600);
                  }, 1400);
              }

              setTimeout(() => { 
                  setWinningPositions(wins); 
                  setIsSpinning(false); 
                  
                  if (scatters >= 3) {
                      const add = scatters===3?5:scatters===4?10:20;
                      setFreeSpins(prev => prev + add);
                      setTimeout(() => {
                          setSlotBanner(`è·å¾— ${add} æ¬¡å…è´¹æ‘‡å¥–ï¼`); setBannerBoost(true); setTimeout(() => setBannerBoost(false), 600);
                      }, 500);
                  }

                  const lineBet = betAmount/10; 
                  let frenzyMult = 1; 
                  if (isFrenzy || isFrenzySpin) { frenzyMult = winningLines > 5 ? 2 : 1.5; }
                  const winAmount = Math.floor(totalMult * lineBet * frenzyMult);
                  
                  if (miniWin) { setPlayer(p=>({...p, money: p.money + jackpots.mini })); setJackpots(prev=>({...prev, mini: JACKPOT_BASES.mini })); setSlotBanner('MINI JACKPOT!'); setBannerBoost(true); setTimeout(()=>setBannerBoost(false),600); }
                  else if (majorWin) { setPlayer(p=>({...p, money: p.money + jackpots.major })); setJackpots(prev=>({...prev, major: JACKPOT_BASES.major })); setSlotBanner('MAJOR JACKPOT!'); setBannerBoost(true); setTimeout(()=>setBannerBoost(false),600); }
                  else if (grandWin) { setPlayer(p=>({...p, money: p.money + jackpots.grand })); setJackpots(prev=>({...prev, grand: JACKPOT_BASES.grand })); setSlotBanner('GRAND JACKPOT!'); setBannerBoost(true); setTimeout(()=>setBannerBoost(false),600); }
                  
                  if (winAmount>0) { 
                      setPlayer(p => ({ ...p, money: p.money + winAmount, mood: Math.min(p.maxMood, p.mood + 5) })); 
                      setSlotMoodMsg('å¿ƒæƒ… +5'); 
                      addLog(`ğŸ° ä¸­å¥–ï¼è·å¾— $${winAmount}${(isFrenzy || isFrenzySpin) ? ` (ç‹‚çƒ­ x${frenzyMult})` : ''}` , 'success'); 
                  } else { 
                      setPlayer(p => ({ ...p, mood: Math.max(0, p.mood - 2) })); 
                      setSlotMoodMsg('å¿ƒæƒ… -2'); 
                      addLog('ğŸ° æœªä¸­å¥–ã€‚', 'error'); 
                  }
                  
                  if (!(isFrenzy || isFrenzySpin)) {
                      const newEnergy = energy + energyGain; 
                      if (newEnergy >= ENERGY_CAP) { 
                          setEnergy(0); 
                          setFrenzySpins(prev=>prev + 5); setIsFrenzy(true); 
                          if (!miniWin && !majorWin && !grandWin) { 
                              setTimeout(() => { setSlotBanner('RADIATION FRENZY!'); setBannerBoost(true); setTimeout(()=>setBannerBoost(false),600); }, 600);
                          }
                      } else { 
                          setEnergy(newEnergy); setIsFrenzy(false); 
                      }
                  } else {
                      if (frenzySpins === 0) setIsFrenzy(false);
                  }
              }, baseDelay);
          };

          const buyItem = (item) => { if (player.money >= item.cost) { setPlayer(prev => ({ ...prev, money: prev.money - item.cost, storage: [...prev.storage, { ...item, type: 'consumable' }] })); addLog(`è´­ä¹°äº† ${item.name}`, 'success'); } else { addLog('èµ„é‡‘ä¸è¶³ï¼', 'error'); } };
          const buyMaterial = (item) => { const price = Math.floor((item.val || 0) * 2); if (player.money >= price) { setPlayer(prev => ({ ...prev, money: prev.money - price, storage: [...prev.storage, { ...item }] })); addLog(`è´­ä¹°ææ–™ ${item.name}ï¼ŒèŠ±è´¹ $${price}`, 'success'); } else { addLog('èµ„é‡‘ä¸è¶³ï¼', 'error'); } };
          const buyGear = (gear) => { if (player.money >= gear.cost) { setPlayer(prev => ({ ...prev, money: prev.money - gear.cost, [gear.type]: gear })); addLog(`è£…å¤‡äº† ${gear.name}`, 'success'); } else { addLog('èµ„é‡‘ä¸è¶³ï¼', 'error'); } };
          const sellItem = (index) => { const item = player.storage[index]; if (!item) return; const sellPrice = item.val || Math.floor(item.cost / 2) || 1; const catRelic = player.relics.find(r => r.id === 'cat'); const finalPrice = catRelic ? Math.floor(sellPrice * 1.2) : sellPrice; setPlayer(prev => ({ ...prev, money: prev.money + finalPrice, storage: prev.storage.filter((_, i) => i !== index) })); addLog(`å‡ºå”® ${item.name}ï¼Œè·å¾— $${finalPrice}`, 'success'); };
          const groupItems = (items) => { const map = new Map(); items.forEach(item => { const key = item.id || `${item.type}:${item.name}`; if (!map.has(key)) map.set(key, { key, item, count: 0, totalVal: 0 }); const g = map.get(key); g.count += 1; g.totalVal += item.val || 0; }); return Array.from(map.values()); };
          const sellOneByKey = (key) => { const idx = player.storage.findIndex(i => (i.id || `${i.type}:${i.name}`) === key); if (idx === -1) return; const item = player.storage[idx]; const sellPrice = item.val || Math.floor(item.cost / 2) || 1; const catRelic = player.relics.find(r => r.id === 'cat'); const finalPrice = catRelic ? Math.floor(sellPrice * 1.2) : sellPrice; setPlayer(prev => ({ ...prev, money: prev.money + finalPrice, storage: prev.storage.filter((_, i) => i !== idx) })); addLog(`å‡ºå”® ${item.name}ï¼Œè·å¾— $${finalPrice}`, 'success'); };
          const useOneByKey = (key) => { const idx = player.storage.findIndex(i => (i.id || `${i.type}:${i.name}`) === key); if (idx === -1) return; const item = player.storage[idx]; if (item.type === 'relic') { if (player.relics.some(r => r.id === item.id)) { addLog('å·²è£…å¤‡è¯¥é—ç‰©ã€‚'); return; } setPlayer(prev => ({ ...prev, relics: [...prev.relics, item], storage: prev.storage.filter((_, i) => i !== idx) })); addLog(`è£…å¤‡é—ç‰©ï¼š${item.name}`, 'success'); return; } if (item.type !== 'consumable') return; let used = false; let newPlayer = { ...player }; if (item.effect === 'heal' && player.hp < player.maxHp) { newPlayer.hp = Math.min(player.maxHp, player.hp + item.value); used = true; } else if (item.effect === 'satiety' && player.satiety < player.maxSatiety) { newPlayer.satiety = Math.min(player.maxSatiety, player.satiety + item.value); used = true; } else if (item.effect === 'mood' && player.mood < player.maxMood) { newPlayer.mood = Math.min(player.maxMood, player.mood + item.value); newPlayer.sanity = Math.max(0, player.sanity - 10); used = true; } else if (item.effect === 'sanity' && player.sanity < player.maxSanity) { newPlayer.sanity = Math.min(player.maxSanity, player.sanity + item.value); used = true; } if (used) { newPlayer.storage = player.storage.filter((_, i) => i !== idx); setPlayer(newPlayer); addLog(`ä½¿ç”¨äº† ${item.name}ã€‚`, 'success'); } };
          const getMaterialNameSet = () => { const names = new Set(); Object.values(FACILITIES).forEach(f => { Object.keys(f.cost).forEach(n => names.add(n)); }); return names; };
          const isMaterial = (item) => item && item.type === 'loot' && getMaterialNameSet().has(item.name);
          const isJunk = (item) => item && item.type === 'loot' && !isMaterial(item);
          const sellAllLoot = () => { const junkItems = player.storage.filter(isJunk); if (junkItems.length === 0) { addLog('æ²¡æœ‰å¯å‡ºå”®çš„æ‚ç‰©ã€‚'); return; } const catRelic = player.relics.find(r => r.id === 'cat'); let totalVal = junkItems.reduce((acc, i) => acc + (i.val || 0), 0); if (catRelic) totalVal = Math.floor(totalVal * 1.2); setPlayer(prev => ({ ...prev, money: prev.money + totalVal, storage: prev.storage.filter(i => !isJunk(i)) })); addLog(`ä¸€é”®å‡ºå”®æ‚ç‰©ï¼Œè·å¾— $${totalVal}`, 'success'); };

          const startRaid = () => { setRaidState({ distance: 0, dangerLevel: 1, currentEnemy: null, isGlitchEnemy: false, tempLoot: [], currentLootItem: null, currentInteractiveEvent: null }); setPlayer(p => ({ ...p, sanity: Math.max(0, p.sanity - 5) })); setScene('raid'); addLog('è¿›å…¥åºŸå¢Ÿ... æ„Ÿè§‰åˆ°è¿™é‡Œå……æ»¡äº†æ¶æ„ã€‚'); };
          const generateLootItem = (dist) => { const rand = Math.random() * 100; const luckBonus = Math.floor(dist / 100); const moodBonus = player.mood > 80 ? 5 : 0; let targetRarity = 'white'; if (dist > 3000 && Math.random() > 0.98) targetRarity = 'special'; else { const score = rand + luckBonus + moodBonus; if (score > 140) targetRarity = 'gold'; else if (score > 115) targetRarity = 'purple'; else if (score > 90) targetRarity = 'blue'; else if (score > 60) targetRarity = 'green'; else targetRarity = 'white'; } let pool = LOOT_DB.filter(i => i.rarity === targetRarity); if (pool.length === 0) pool = LOOT_DB.filter(i => i.rarity === 'white'); return pool[Math.floor(Math.random() * pool.length)]; };
          const explore = () => { if (player.satiety <= 0) { addLog('ä½ é¥¿å¾—èµ°ä¸åŠ¨äº†... ç”Ÿå‘½å€¼æ­£åœ¨æµå¤±ï¼', 'danger'); setPlayer(p => ({ ...p, hp: Math.max(0, p.hp - 10) })); if (player.hp <= 10) setScene('gameover'); return; } const newDist = raidState.distance + 100; const rng = Math.random(); const currentDanger = 1 + Math.floor(newDist / 500); const satBase = 5, sanBase = 2; let satCost = satBase, sanCost = sanBase; if (player.mood < 15) { satCost += 5; sanCost += 2; } else if (player.mood < 30) { satCost += 2; sanCost += 1; } setPlayer(prev => ({ ...prev, satiety: Math.max(0, prev.satiety - satCost), sanity: Math.max(0, prev.sanity - sanCost) })); setRaidState(prev => ({ ...prev, distance: newDist, dangerLevel: currentDanger })); addLog(`æ·±å…¥åºŸå¢Ÿ ${newDist}m... (é¥±é£Ÿ-${satCost}, San-${sanCost})`); if (player.sanity < 50 && Math.random() > 0.7) addLog('ä½ å¬åˆ°è€³è¾¹æœ‰å¥‡æ€ªçš„ä½è¯­...', 'danger'); if (rng < 0.2) { const event = STORY_EVENTS[Math.floor(Math.random() * STORY_EVENTS.length)]; setRaidState(prev => ({ ...prev, currentInteractiveEvent: event })); setScene('interactive_event'); addLog('å‰æ–¹å‡ºç°å¼‚å¸¸æƒ…å†µ...', 'blue'); return; } if (rng < 0.45) { let enemy = null; let isGlitch = false; if (player.sanity < 30 && Math.random() < 0.6) { isGlitch = true; const madnessScale = (50 - player.sanity) / 10; enemy = { name: '?&%#@!', hp: 50 + (madnessScale * 20), maxHp: 50 + (madnessScale * 20), atk: 8 + (madnessScale * 3), exp: 0 }; } else { const enemyPool = ENEMIES.filter((_, idx) => idx < currentDanger); const enemyTemplate = enemyPool[Math.floor(Math.random() * enemyPool.length)] || ENEMIES[ENEMIES.length-1]; enemy = { ...enemyTemplate, maxHp: enemyTemplate.hp }; } setRaidState(prev => ({ ...prev, currentEnemy: enemy, isGlitchEnemy: isGlitch })); setPlayer(p => ({ ...p, sanity: Math.max(0, p.sanity - 5), mood: Math.max(0, p.mood - 2) })); setScene('combat'); if (isGlitch) addLog('è­¦å‘Šï¼šé­é‡ä¸å¯åçŠ¶çš„å®ä½“ï¼', 'danger'); else addLog(`é­é‡æ•Œå¯¹ç›®æ ‡ï¼š${enemy.name}ï¼`, 'danger'); } else if (rng < 0.8) { const lootItem = generateLootItem(newDist); setRaidState(prev => ({ ...prev, tempLoot: [...prev.tempLoot, lootItem], currentLootItem: lootItem })); setPlayer(p => ({ ...p, mood: Math.min(p.maxMood, p.mood + 5) })); addLog(`å‘ç°ç‰©èµ„ï¼š${lootItem.name}`, 'success'); setScene('event'); } else { setPlayer(p => ({ ...p, mood: Math.max(0, p.mood - 1) })); addLog('å‘¨å›´å¾ˆå®‰é™ï¼Œä¹Ÿè®¸å¤ªå®‰é™äº†ã€‚'); } };
          const handleCombat = (action) => { if (!raidState.currentEnemy) return; if (action === 'attack') { let hitChance = 0.9; let xfinalAtk = player.weapon.atk; const adrenalineRelic = player.relics.find(r => r.id === 'adrenaline'); if (adrenalineRelic && player.hp < player.maxHp * 0.3) { xfinalAtk *= 2; addLog('è‚¾ä¸Šè…ºç´ æ¿€æ´»ï¼ä¼¤å®³ç¿»å€ï¼', 'blue'); } if (player.mood > 80) { } if (player.mood < 30) { hitChance = 0.6; } if (raidState.isGlitchEnemy) { setPlayer(p => ({ ...p, satiety: Math.max(0, p.satiety - 2) })); addLog('æ”»å‡»è¿™ä¸ªæ€ªç‰©è®©ä½ æ„Ÿåˆ°å¼‚å¸¸ç–²æƒ«...(é¥±é£Ÿ-2)', 'danger'); } if (Math.random() > hitChance) { addLog('ä½ çš„æ”»å‡»è½ç©ºäº†ï¼(å¿ƒæƒ…ä½è½)', 'error'); setPlayer(p => ({ ...p, mood: Math.max(0, p.mood - 1) })); } else { let dmg = Math.max(1, xfinalAtk + Math.floor(Math.random() * 3)); const remainingEnemyHp = raidState.currentEnemy.hp - dmg; addLog(`ä½ é€ æˆäº† ${dmg} ç‚¹ä¼¤å®³ã€‚`); if (remainingEnemyHp <= 0) { addLog(`å‡»è´¥äº†æ•Œäººï¼`, 'success'); const enemy = raidState.currentEnemy; const baseReward = Math.floor(((enemy?.exp || 20) * 1.5) + ((enemy?.atk || 5) * 3)); const moneyReward = Math.max(10, baseReward * raidState.dangerLevel + Math.floor(Math.random() * 20)); const dropItems = []; if (Math.random() < 0.6) dropItems.push({ ...ITEMS.food, type: 'consumable' }); if (Math.random() < 0.3) dropItems.push({ ...ITEMS.medkit, type: 'consumable' }); if (player.facilities.workbench && Math.random() < 0.2) dropItems.push({ ...ITEMS.ammo_box, type: 'consumable' }); setPlayer(p => ({ ...p, money: p.money + moneyReward, storage: [...p.storage, ...dropItems] })); addLog(`è·å¾— $${moneyReward}${dropItems.length ? 'ï¼Œå¹¶æ‹¾å– ' + dropItems.map(i => i.name).join('ã€') : ''}`, 'success'); const vampireRelic = player.relics.find(r => r.id === 'vampire'); if (vampireRelic) { setPlayer(p => ({ ...p, hp: Math.min(p.maxHp, p.hp + 5) })); addLog('å¸è¡€é¬¼ä¹‹ç‰™ï¼šæ±²å–äº† 5 ç‚¹ç”Ÿå‘½ã€‚', 'blue'); } setPlayer(p => ({ ...p, mood: Math.min(p.maxMood, p.mood + 5) })); setRaidState(prev => ({ ...prev, currentEnemy: null })); setScene('raid'); return; } setRaidState(prev => ({ ...prev, currentEnemy: { ...prev.currentEnemy, hp: remainingEnemyHp } })); } const enemyDmg = Math.max(0, raidState.currentEnemy.atk - player.armor.def); setPlayer(prev => ({ ...prev, hp: prev.hp - enemyDmg, mood: Math.max(0, prev.mood - 2) })); if(enemyDmg > 0) triggerShake(); addLog(`æ•Œäººåå‡»ï¼å—åˆ° ${enemyDmg} ç‚¹ä¼¤å®³ã€‚`, 'danger'); if (player.hp - enemyDmg <= 0) setScene('gameover'); } else if (action === 'flee') { let fleeChance = 0.5; if (player.mood > 80) fleeChance = 0.7; if (player.mood < 30) fleeChance = 0.3; if (Math.random() < fleeChance) { addLog('é€ƒè·‘æˆåŠŸï¼'); setRaidState(prev => ({ ...prev, currentEnemy: null })); setPlayer(p => ({ ...p, mood: Math.min(p.maxMood, p.mood + 2) })); addLog('çŸ­æš‚å–˜æ¯ï¼šå¿ƒæƒ… +2', 'success'); setScene('raid'); } else { addLog('é€ƒè·‘å¤±è´¥ï¼è¢«æ•Œäººè¿½ä¸Šäº†ã€‚', 'danger'); const enemyDmg = Math.max(0, raidState.currentEnemy.atk - player.armor.def); setPlayer(prev => ({ ...prev, hp: prev.hp - enemyDmg })); triggerShake(); if (player.hp - enemyDmg <= 0) setScene('gameover'); } } };
          const evac = () => { const healAmount = player.facilities.medical ? 40 : 20; setPlayer(prev => ({ ...prev, hp: Math.min(prev.maxHp, prev.hp + healAmount), sanity: Math.min(prev.maxSanity, prev.sanity + 20), storage: [...prev.storage, ...raidState.tempLoot] })); addLog(`æ’¤ç¦»æˆåŠŸï¼ç‰©èµ„å·²è½¬è¿è‡³ä»“åº“ã€‚`, 'success'); setScene('result'); };
          const resetGame = () => { setPlayer({ hp: 100, maxHp: 100, satiety: 100, maxSatiety: 100, mood: 100, maxMood: 100, sanity: 100, maxSanity: 100, money: 500, weapon: GEAR.knife, armor: GEAR.clothes, relics: [], facilities: {}, inventory: [], storage: [], }); setScene('intro'); setIntroStep(0); setLogs(['é‡æ–°å¼€å§‹ã€‚ç¥ä½ å¥½è¿ï¼Œè¡Œè€…ã€‚']); }
          
          const CRTOverlay = () => { const glitchIntensity = player.sanity < 30 ? 'opacity-30' : 'opacity-0'; return ( <div className="pointer-events-none absolute inset-0 z-[60] overflow-hidden rounded-lg"> <div className="scanline"></div> <div className="absolute inset-0 bg-[linear-gradient(rgba(0,0,0,0)_50%,rgba(0,0,0,0.2)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%] pointer-events-none" /> <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_50%,rgba(0,0,0,0.4)_100%)] pointer-events-none" /> <div className={`absolute inset-0 bg-noise mix-blend-overlay ${glitchIntensity} pointer-events-none transition-opacity duration-1000`}></div> {player.sanity < 50 && ( <div className="absolute top-2 left-2 text-[10px] text-red-500 animate-pulse font-bold tracking-widest">âš  MENTAL CRITICAL</div> )} </div> ); };

          useEffect(() => { if (scene === 'intro') { if (introStep < introTexts.length) { const timer = setTimeout(() => { setIntroStep(prev => prev + 1); }, 1500); return () => clearTimeout(timer); } } }, [scene, introStep]);
          useEffect(() => { if (introEndRef.current) { introEndRef.current.scrollIntoView({ behavior: 'smooth' }); } }, [introStep]);

          const inSpecialMode = freeSpins > 0 || frenzySpins > 0 || isFrenzy;

          return (
            <div className={`min-h-screen bg-neutral-900 flex items-center justify-center p-4 font-mono text-slate-200 select-none ${isShake ? 'shake-anim' : ''}`}>
              <div className="game-container relative w-full max-w-lg bg-slate-800 rounded-2xl p-6 border-b-8 border-r-8 border-slate-950 shadow-2xl min-h-safe flex flex-col my-2">
                
                {scene !== 'intro' && (
                    <div className="mb-2 flex-none border-b-4 border-slate-600 pb-2">
                       <div className="flex justify-between items-end mb-2">
                           <div>
                             <h1 className="text-3xl text-yellow-500 leading-none mb-1 tracking-wider">åºŸåœŸè¡ŒåŠ¨</h1>
                             <span className="text-lg text-slate-400">EXTRACTION RPG</span>
                           </div>
                           <div className="text-right">
                             <div className="text-green-400 text-2xl flex items-center gap-1 justify-end font-bold">
                                <span className="text-sm">$</span> {player.money.toLocaleString()}
                             </div>
                             <div className="text-lg text-slate-500">DAY {Math.floor(raidState.distance / 1000) + 1}</div>
                           </div>
                       </div>
                       <div className="px-1">
                            <div className="flex justify-between text-[10px] text-yellow-600 mb-1 font-bold">
                                <span>æ’¤ç¦»é£èˆ¹å¯åŠ¨èµ„é‡‘è¿›åº¦</span>
                                <span>{Math.floor((player.money/WIN_GOAL)*100)}%</span>
                            </div>
                            <div className="h-1 bg-slate-900 border border-slate-700 rounded-full overflow-hidden">
                                <div className="h-full bg-yellow-500 transition-all duration-1000" style={{width: `${Math.min(100, (player.money/WIN_GOAL)*100)}%`}}></div>
                            </div>
                       </div>
                    </div>
                )}

                <div className="relative bg-[#1a1c21] border-4 border-slate-700 rounded-lg flex-1 flex flex-col justify-between overflow-hidden shadow-[inset_0_0_20px_rgba(0,0,0,0.8)] min-h-0">
                    <CRTOverlay />
                    
                    {scene === 'intro' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-6 bg-black z-20 overflow-y-auto relative w-full h-full" onClick={() => setIntroStep(prev => Math.min(prev + 1, introTexts.length))}>
                            <button onClick={(e) => { e.stopPropagation(); setIntroStep(introTexts.length); }} className="absolute top-4 right-4 text-slate-600 text-sm border border-slate-700 px-2 py-1 rounded hover:text-slate-400 z-50">SKIP >></button>
                            <div className="space-y-4 w-full max-w-lg z-10">
                                {introTexts.slice(0, introStep + 1).map((text, i) => (
                                    <p key={i} className={`text-green-500 text-lg leading-relaxed animate-in fade-in slide-in-from-bottom-2 duration-500 ${i === introTexts.length -1 ? 'text-red-500 font-bold' : 'opacity-80'}`}>
                                        {text}
                                    </p>
                                ))}
                                <div ref={introEndRef}></div>
                            </div>
                            {introStep >= introTexts.length ? (
                                <button onClick={(e) => { e.stopPropagation(); setScene('home'); setLogs(["æ¬¢è¿å›æ¥ã€‚å½“å‰çš„æ’¤ç¦»ç›®æ ‡æ˜¯ç­¹é½ $32,500ã€‚"]); }} className="mt-8 px-8 py-3 bg-green-900/50 border-2 border-green-500 text-green-400 text-2xl hover:bg-green-800 animate-pulse mb-8 z-50 pointer-events-auto">INITIALIZE ></button>
                            ) : (
                                <div className="text-slate-600 text-sm animate-pulse mt-8">ç‚¹å‡»å±å¹•åŠ é€Ÿ...</div>
                            )}
                        </div>
                    )}

                    {scene !== 'intro' && (
                        <div className="relative z-10 p-4 flex-1 flex flex-col h-full overflow-hidden min-h-0">
                            {scene !== 'victory' && (
                                <div className="bg-slate-800/80 p-3 rounded mb-4 border border-slate-600 backdrop-blur-sm grid grid-cols-2 gap-x-4 gap-y-2 flex-none">
                                    <div className="col-span-2">
                                         <div className="flex justify-between text-sm text-slate-400 mb-1">
                                            <span>HP {player.hp}/{player.maxHp}</span>
                                            <span className="flex gap-1">{player.relics.map((r,i) => <Gem key={i} size={12} className="text-purple-400"/>)}</span>
                                         </div>
                                         <ProgressBar current={player.hp} max={player.maxHp} color="bg-red-600" icon={<Heart size={14} className="text-red-500"/>} />
                                    </div>
                                    <div>
                                         <ProgressBar current={player.satiety} max={player.maxSatiety} color="bg-yellow-600" icon={<Utensils size={14} className="text-yellow-500"/>} />
                                         <div className="flex justify-between text-xs text-slate-500 mt-0.5"><span>é¥±é£Ÿ</span><span>{player.satiety}/{player.maxSatiety}</span></div>
                                    </div>
                                    <div>
                                         <ProgressBar current={player.sanity} max={player.maxSanity} color="bg-blue-600" icon={<Activity size={14} className="text-blue-500"/>} />
                                         <div className="flex justify-between text-xs text-slate-500 mt-0.5"><span>ç†æ™º</span><span>{player.sanity}/{player.maxSanity}</span></div>
                                    </div>
                                    <div className="col-span-2">
                                         <ProgressBar current={player.mood} max={player.maxMood} color="bg-purple-500" icon={<Smile size={14} className="text-purple-400"/>} />
                                         <div className="flex justify-between text-xs text-slate-500 mt-0.5"><span>å¿ƒæƒ…</span><span>{player.mood}/{player.maxMood}</span></div>
                                    </div>
                                </div>
                            )}

                            {scene === 'home' && (
                              <div className="flex-1 flex flex-col items-center justify-center gap-4 text-center fade-in overflow-y-auto">
                                <div className="grid grid-cols-2 gap-4 w-full">
                                    {player.money >= WIN_GOAL && (
                                        <PixelCard onClick={() => setScene('victory')} className="col-span-2 bg-yellow-900/40 border-yellow-500 fever-mode py-6 victory-pulse">
                                            <div className="flex flex-col items-center">
                                                <Rocket className="mb-2 text-yellow-400" size={48} />
                                                <span className="text-3xl text-yellow-400 font-bold tracking-widest">ç»ˆææ’¤ç¦»</span>
                                                <span className="text-sm text-yellow-600 mt-1 uppercase">æ¿€æ´»é£èˆ¹åè®®</span>
                                            </div>
                                        </PixelCard>
                                    )}
                                    <PixelCard onClick={() => { setScene('shop'); setShopTab('buy'); }}>
                                        <div className="flex flex-col items-center py-2">
                                            <ShoppingBag className="mb-2 text-yellow-500" size={32} />
                                            <span className="text-2xl">é»‘å¸‚äº¤æ˜“</span>
                                        </div>
                                    </PixelCard>
                                    <PixelCard onClick={() => setScene('hideout')}>
                                        <div className="flex flex-col items-center py-2">
                                            <Hammer className="mb-2 text-orange-500" size={32} />
                                            <span className="text-2xl">è—èº«å¤„</span>
                                        </div>
                                    </PixelCard>
                                    <PixelCard onClick={startRaid}>
                                        <div className="flex flex-col items-center py-2">
                                            <LogOut className="mb-2 text-red-500" size={32} />
                                            <span className="text-2xl">å¼€å§‹æ¢ç´¢</span>
                                        </div>
                                    </PixelCard>
                                    <PixelCard onClick={() => setScene('storage')}>
                                       <div className="flex flex-col items-center py-2">
                                            <Briefcase className="mb-2 text-blue-500" size={32} />
                                            <span className="text-2xl">ç‰©èµ„ä»“åº“</span>
                                        </div>
                                    </PixelCard>
                                    <PixelCard onClick={() => setScene('equipment')} className="col-span-2">
                                       <div className="flex flex-col items-center py-2">
                                            <Shield className="mb-2 text-slate-300" size={32} />
                                            <span className="text-2xl">è§’è‰²è£…å¤‡</span>
                                        </div>
                                    </PixelCard>
                                </div>
                              </div>
                            )}

                            {scene === 'shop' && (
                                <div className="flex-1 flex flex-col h-full overflow-hidden fade-in min-h-0 relative">
                                    <div className="flex-none bg-[#1a1c21] z-10 border-b border-slate-700 pb-2 mb-2">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-2xl text-yellow-500 tracking-widest">=== é»‘å¸‚ ===</span>
                                            <span className="text-green-400 text-xl flex items-center gap-1"><Coins size={20}/> ${player.money.toLocaleString()}</span>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2">
                                            <button onClick={() => setShopTab('buy')} className={`py-1 text-lg rounded ${shopTab === 'buy' ? 'bg-yellow-700 text-white' : 'bg-slate-800 text-slate-400'}`}>è¡¥ç»™</button>
                                            <button onClick={() => setShopTab('gamble')} className={`py-1 text-lg rounded ${shopTab === 'gamble' ? 'bg-purple-700 text-white' : 'bg-slate-800 text-slate-400'}`}>èµŒåœº</button>
                                            <button onClick={() => setShopTab('exchange')} className={`py-1 text-lg rounded ${shopTab === 'exchange' ? 'bg-blue-700 text-white' : 'bg-slate-800 text-slate-400'}`}>äº¤æ˜“æ‰€</button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-2 min-h-0">
                                        {shopTab === 'buy' ? (
                                            <>
                                                <h3 className="text-base text-slate-500 uppercase tracking-widest border-b border-slate-700/50 mt-2">ç”Ÿå­˜è¡¥ç»™</h3>
                                                {Object.values(ITEMS).filter(i => i.cost > 0).map(item => (
                                                    <div key={item.id} onClick={() => handleShopClick(item, 'item')} className={`group p-3 border cursor-pointer flex justify-between items-center rounded transition-all duration-200 ${confirmId === item.id ? 'bg-yellow-900/30 border-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.3)]' : 'bg-slate-800/50 border-slate-600 hover:bg-slate-700 hover:border-blue-600/50'}`}>
                                                        <div>
                                                            <div className={`text-2xl ${confirmId === item.id ? 'text-yellow-400 font-bold' : 'text-blue-400 group-hover:text-blue-300'}`}>{confirmId === item.id ? `ç¡®è®¤è´­ä¹°?` : item.name}</div>
                                                            <div className="text-lg text-slate-500">{confirmId === item.id ? 'å†æ¬¡ç‚¹å‡»ç¡®è®¤' : item.desc}</div>
                                                        </div>
                                                        <div className="text-2xl font-bold text-yellow-500">${item.cost}</div>
                                                    </div>
                                                ))}
                                                <h3 className="text-base text-slate-500 uppercase tracking-widest border-b border-slate-700/50 mt-4">æ­¦å™¨ & æŠ¤ç”²</h3>
                                                {Object.values(GEAR).filter(g => g.cost > 0).map(item => (
                                                    <div key={item.id} onClick={() => handleShopClick(item, 'gear')} className={`group p-3 border cursor-pointer flex justify-between items-center rounded transition-all duration-200 ${confirmId === item.id ? 'bg-yellow-900/30 border-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.3)]' : 'bg-slate-800/50 border-slate-600 hover:bg-slate-700 hover:border-yellow-600/50'}`}>
                                                        <div>
                                                            <div className={`text-2xl ${confirmId === item.id ? 'text-yellow-400 font-bold' : 'text-green-400 group-hover:text-green-300'}`}>{confirmId === item.id ? `ç¡®è®¤è´­ä¹°?` : item.name}</div>
                                                            <div className="text-lg text-slate-500">{confirmId === item.id ? 'å†æ¬¡ç‚¹å‡»ç¡®è®¤' : item.desc}</div>
                                                        </div>
                                                        <div className="text-2xl font-bold text-yellow-500">${item.cost}</div>
                                                    </div>
                                                ))}
                                                <h3 className="text-base text-slate-500 uppercase tracking-widest border-b border-slate-700/50 mt-4">è®¾æ–½ææ–™ï¼ˆä»·æ ¼=å›æ”¶ä»·Ã—2ï¼‰</h3>
                                                {LOOT_DB.filter(isMaterial).map(mat => {
                                                    const key = mat.name;
                                                    const price = Math.floor((mat.val || 0) * 2);
                                                    return (
                                                        <div key={`mat-${key}`} onClick={() => handleShopClick(mat, 'material')} className={`group p-3 border cursor-pointer flex justify-between items-center rounded transition-all duration-200 ${confirmId === key ? 'bg-yellow-900/30 border-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.3)]' : 'bg-slate-800/50 border-slate-600 hover:bg-slate-700 hover:border-blue-600/50'}`}>
                                                            <div>
                                                                <div className={`text-2xl ${confirmId === key ? 'text-yellow-400 font-bold' : 'text-blue-400 group-hover:text-blue-300'}`}>{confirmId === key ? `ç¡®è®¤è´­ä¹°?` : mat.name}</div>
                                                                <div className="text-lg text-slate-500">{confirmId === key ? 'å†æ¬¡ç‚¹å‡»ç¡®è®¤' : `å›æ”¶ä»· $${mat.val} | è´­ä¹°ä»· $${price}`}</div>
                                                            </div>
                                                            <div className="text-2xl font-bold text-yellow-500">${price}</div>
                                                        </div>
                                                    );
                                                })}
                                            </>
                                        ) : shopTab === 'gamble' ? (
                                            <div className="flex flex-col items-center pt-2">
                                                <div className="flex justify-between items-center w-full mb-3 px-4">
                                                    <button onClick={() => setShowCasinoRules(true)} className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 border border-slate-600 text-blue-400 hover:text-blue-300 hover:bg-slate-700 shadow-[0_0_10px_rgba(59,130,246,0.3)] transition-all">
                                                        <HelpCircle size={18} />
                                                    </button>
                                                    <button 
                                                        onClick={() => {
                                                            if (inSpecialMode || isSpinning) return;
                                                            const next = !isVipMode;
                                                            setIsVipMode(next);
                                                            setBetAmount(next ? 500 : 50); 
                                                        }} 
                                                        disabled={inSpecialMode || isSpinning}
                                                        className={`px-6 py-1.5 font-bold text-lg rounded border transition-colors ${(inSpecialMode || isSpinning) ? 'opacity-50 cursor-not-allowed grayscale ' : ''}${isVipMode ? 'bg-red-900/50 border-red-500 text-red-400 shadow-[0_0_10px_rgba(220,38,38,0.5)]' : 'bg-slate-800 border-slate-600 text-slate-400'}`}
                                                    >
                                                        {isVipMode ? 'ğŸ”¥ VIPé«˜å±æ¨¡å¼' : 'æ™®é€šæ¨¡å¼'}
                                                    </button>
                                                    <div className="w-8"></div>
                                                </div>
                                                {isVipMode && <div className="text-[10px] text-red-500 mb-2 mt-[-8px]">æå“ç¿»å€ | éª·é«…å‰§å¢ | ä¸‹æ³¨ä¸Šé™ $5000</div>}
                                                <div className="text-[12px] text-slate-400 px-4 mb-2 flex flex-wrap items-center gap-1">
                                                    <span className="text-slate-500">å¥–åŠ±æ ¼å­ï¼š</span>
                                                    {(() => {
                                                        const all = ['ğŸ’€','ğŸ”§','ğŸ—','â˜¢ï¸','ğŸ’','7ï¸âƒ£','ğŸƒ','â­'];
                                                        const allowed = new Set(['ğŸ’€','ğŸ”§']);
                                                        if (isVipMode || betAmount >= 50) { allowed.add('ğŸ—'); allowed.add('â˜¢ï¸'); allowed.add('ğŸƒ'); }
                                                        if (isVipMode || betAmount >= 100) { allowed.add('ğŸ’'); allowed.add('7ï¸âƒ£'); allowed.add('â­'); }
                                                        const lit = all.filter(s => allowed.has(s));
                                                        const dim = all.filter(s => !allowed.has(s));
                                                        return (
                                                            <>
                                                                <span className="text-yellow-400 mr-2">{lit.map(s => (<span key={`l-${s}`} className="mx-1">{s}</span>))}</span>
                                                                <span className="text-slate-500">{dim.map(s => (<span key={`d-${s}`} className="mx-1 opacity-40">{s}</span>))}</span>
                                                            </>
                                                        );
                                                    })()}
                                                </div>
                                                
                                                <SlotMachine5x3 
                                                    bet={betAmount}
                                                    onSpin={handleSpin5x3}
                                                    isSpinning={isSpinning}
                                                    result={slotGrid}
                                                    moodMsg={slotMoodMsg}
                                                    jackpots={jackpots}
                                                    energy={energy}
                                                    isFrenzy={isFrenzy || frenzySpins>0}
                                                    freeSpins={freeSpins}
                                                    frenzySpins={frenzySpins}
                                                    teaserCol={teaserCol}
                                                    winningPositions={winningPositions}
                                                    bannerText={slotBanner}
                                                    bannerBoost={bannerBoost}
                                                    isVipMode={isVipMode}
                                                    energyCap={ENERGY_CAP}
                                                />
                                                <div className="flex gap-4 mt-2 w-full justify-center">
                                                    <button disabled={inSpecialMode || isSpinning} onClick={() => setBetAmount(Math.max(isVipMode ? 500 : 10, betAmount - (isVipMode ? 100 : 10)))} className={`bg-slate-700 px-4 py-2 rounded border border-slate-500 text-xl ${(inSpecialMode || isSpinning) ? 'opacity-50 cursor-not-allowed' : ''}`}>-</button>
                                                    <div className={`bg-black/50 px-6 py-2 rounded text-xl border border-slate-600 w-32 text-center ${isVipMode ? 'text-red-500' : 'text-yellow-500'}`}>${betAmount}</div>
                                                    <button disabled={inSpecialMode || isSpinning} onClick={() => setBetAmount(Math.min(player.money, betAmount + (isVipMode ? 100 : 10)))} className={`bg-slate-700 px-4 py-2 rounded border border-slate-500 text-xl ${(inSpecialMode || isSpinning) ? 'opacity-50 cursor-not-allowed' : ''}`}>+</button>
                                                </div>
                                                <button disabled={inSpecialMode || isSpinning} onClick={() => setBetAmount(Math.min(player.money, isVipMode ? 5000 : 500))} className={`text-sm mt-2 underline ${(inSpecialMode || isSpinning) ? 'text-slate-700 cursor-not-allowed' : 'text-slate-500'}`}>MAX BET (${isVipMode ? 5000 : 500})</button>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col pt-2">
                                                <div className={`mx-4 mb-2 px-3 py-2 rounded border ${exchangeNews ? 'border-blue-500/50 bg-blue-900/10 text-blue-300' : 'border-slate-700 bg-slate-800 text-slate-400'} text-sm truncate`}>{exchangeNews ? exchangeNews.text : 'ä»Šæ—¥æš‚æ— é‡å¤§æ–°é—»â€¦â€¦'}</div>
                                                <div className="px-2 space-y-2">
                                                    {exchangeAssets.map(a => {
                                                        const up = a.change > 0; const down = a.change < 0; const color = up ? 'text-green-400' : down ? 'text-red-400' : 'text-slate-400';
                                                        const selected = selectedAssetId === a.id;
                                                        return (
                                                            <div key={a.id} onClick={() => setSelectedAssetId(a.id)} className={`p-3 border rounded cursor-pointer ${selected ? 'bg-blue-900/20 border-blue-500' : 'bg-slate-800 border-slate-600'} flex items-center justify-between`}>
                                                                <div className="min-w-0">
                                                                    <div className="text-xl text-slate-200 truncate max-w-[50vw]">{a.name}</div>
                                                                    <div className="text-sm text-slate-500">æŒæœ‰ {a.held} ä»½</div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-2xl text-yellow-500 font-bold">${a.price}</div>
                                                                    <div className={`text-sm ${color}`}>{a.change > 0 ? '+' : ''}{a.change}%</div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                <div className="mt-2 px-2 pt-2 border-t border-slate-700">
                                                    {(() => {
                                                        const sa = exchangeAssets.find(x => x.id === selectedAssetId) || exchangeAssets[0];
                                                        const maxBuyQty = Math.floor(player.money / ((sa?.price || 1) * (1 + EXCHANGE_FEE_RATE)));
                                                        const maxSellQty = sa?.held || 0;
                                                        const canBuy = maxBuyQty > 0;
                                                        const canSell = maxSellQty > 0;
                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="flex items-center justify-between flex-wrap gap-y-1">
                                                                    <div className="text-slate-400 min-w-0 truncate">é€‰ä¸­ï¼š<span className="text-slate-200">{sa?.name}</span> @ <span className="text-yellow-500">${sa?.price}</span></div>
                                                                    <div className="text-slate-500">æŒæœ‰ {sa?.held} ä»½</div>
                                                                </div>
                                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                                                    <div className="p-2 border rounded bg-slate-800 border-slate-600 min-w-0 text-sm sm:text-base">
                                                                        <div className="text-slate-300 mb-1">ä¹°å…¥</div>
                                                                        <div className="flex items-center flex-wrap gap-2">
                                                                            <button onClick={() => setBuyQty(q => Math.max(1, q - 1))} className="px-2 py-1 bg-slate-700 border border-slate-600 rounded">-</button>
                                                                            <div className="px-3 py-1 bg-black/40 text-yellow-400 rounded border border-slate-700">{buyQty}</div>
                                                                            <button onClick={() => setBuyQty(q => Math.min(maxBuyQty || 1, q + 1))} className="px-2 py-1 bg-slate-700 border border-slate-600 rounded">+</button>
                                                                            <button onClick={() => buyAsset(sa.id, buyQty)} disabled={!canBuy || buyQty <= 0 || player.money < (sa.price * buyQty * (1 + EXCHANGE_FEE_RATE))} className={`ml-2 px-3 py-1 rounded border ${(!canBuy || player.money < (sa.price * buyQty * (1 + EXCHANGE_FEE_RATE))) ? 'bg-slate-700 border-slate-700 text-slate-400' : 'bg-green-700 border-green-800 text-white hover:bg-green-600'}`}>ä¹°å…¥</button>
                                                                            <button onClick={() => { const qty = Math.floor(player.money / (sa.price * (1 + EXCHANGE_FEE_RATE))); if (qty>0){ setBuyQty(qty); buyAsset(sa.id, qty);} }} disabled={!canBuy} className={`px-3 py-1 rounded border ${!canBuy ? 'bg-slate-700 border-slate-700 text-slate-400' : 'bg-blue-700 border-blue-800 text-white hover:bg-blue-600'}`}>æ¢­å“ˆ</button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="p-2 border rounded bg-slate-800 border-slate-600 min-w-0 text-sm sm:text-base">
                                                                        <div className="text-slate-300 mb-1">å–å‡º</div>
                                                                        <div className="flex items-center flex-wrap gap-2">
                                                                            <button onClick={() => setSellQty(q => Math.max(1, q - 1))} className="px-2 py-1 bg-slate-700 border border-slate-600 rounded">-</button>
                                                                            <div className="px-3 py-1 bg-black/40 text-red-400 rounded border border-slate-700">{sellQty}</div>
                                                                            <button onClick={() => setSellQty(q => Math.min(maxSellQty || 1, q + 1))} className="px-2 py-1 bg-slate-700 border border-slate-600 rounded">+</button>
                                                                            <button onClick={() => sellAsset(sa.id, sellQty)} disabled={!canSell || sellQty <= 0 || sellQty > sa.held} className={`ml-2 px-3 py-1 rounded border ${(!canSell || sellQty > sa.held) ? 'bg-slate-700 border-slate-700 text-slate-400' : 'bg-orange-700 border-orange-800 text-white hover:bg-orange-600'}`}>å–å‡º</button>
                                                                            <button onClick={() => sellAssetAll(sa.id)} disabled={!canSell} className={`px-3 py-1 rounded border ${!canSell ? 'bg-slate-700 border-slate-700 text-slate-400' : 'bg-red-700 border-red-800 text-white hover:bg-red-600'}`}>æ¸…ä»“</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="text-[10px] text-slate-500 mt-1">äº¤æ˜“è´¹ 2%ï¼ˆä¹°å…¥ä¸å–å‡ºå‡æ”¶å–ï¼‰</div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex-none pt-3 border-t border-slate-700 mt-2">
                                        <button onClick={() => setScene('home')} className="w-full bg-slate-700 p-3 text-xl hover:bg-slate-600 border border-slate-500 text-slate-300 rounded">è¿”å›å®‰å…¨å±‹</button>
                                    </div>

                                    {/* --- èµŒåœºè§„åˆ™å¼¹çª— --- */}
                                    {showCasinoRules && (
                                        <div className="absolute inset-0 bg-black/95 z-[80] flex flex-col p-4 fade-in rounded-lg overflow-hidden">
                                            <div className="flex justify-between items-center border-b border-slate-700 pb-2 mb-4 flex-none">
                                                <h2 className="text-2xl text-yellow-500 tracking-widest flex items-center gap-2"><HelpCircle size={24}/> èµŒåœºç”Ÿå­˜æŒ‡å—</h2>
                                                <button onClick={() => setShowCasinoRules(false)} className="text-slate-500 hover:text-white"><LogOut size={24}/></button>
                                            </div>
                                            <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-4 text-sm text-slate-300">
                                                <div className="bg-slate-800 p-3 rounded border border-red-500/50">
                                                    <h3 className="text-red-400 text-lg mb-1 font-bold">ğŸ° é£å¤©å¤§çš‡å®«ï¼šçˆ†é‡‘è§„åˆ™è¯´æ˜ (Instruction)</h3>
                                                    <p className="text-slate-300">åœ¨å¼€å§‹æ¸¸æˆå‰ï¼Œè¯·èŠ±ä¸€åˆ†é’Ÿäº†è§£ä»¥ä¸‹è§„åˆ™ï¼Œä»¥ä¼˜åŒ–æ‚¨çš„æŠ•æ³¨ç­–ç•¥ã€‚</p>
                                                </div>
                                                <div className="bg-slate-800 p-3 rounded border border-slate-700">
                                                    <h3 className="text-yellow-500 text-lg mb-1 font-bold">ğŸ“Œ åŸºç¡€æœ¯è¯­è§£é‡Š</h3>
                                                    <p className="mb-1">è€è™æœºå…±æœ‰ 5 ä¸ªè½¬è½´ã€‚å½“ç›¸åŒçš„ç¬¦å·åœ¨ä¸€æ¡æœ‰æ•ˆä¸­å¥–çº¿ä¸Šï¼Œä»æœ€å·¦ä¾§èµ·è¿ç»­å‡ºç°æ—¶ï¼Œå³è§†ä¸ºä¸­å¥–ã€‚</p>
                                                    <p className="mb-0">3è¿ï¼šå‰ 3 ä¸ªè½¬è½´å‡ºç°ç›¸åŒç¬¦å·ã€‚</p>
                                                    <p className="mb-0">4è¿ï¼šå‰ 4 ä¸ªè½¬è½´å‡ºç°ç›¸åŒç¬¦å·ã€‚</p>
                                                    <p>5è¿ï¼šå…¨éƒ¨ 5 ä¸ªè½¬è½´å‡ºç°ç›¸åŒç¬¦å·ï¼ˆé€šå¸¸è§¦å‘è¯¥ç¬¦å·çš„æœ€é«˜å¥–åŠ±ï¼‰ã€‚</p>
                                                </div>
                                                <div className="bg-slate-800 p-3 rounded border border-slate-700">
                                                    <h3 className="text-blue-400 text-lg mb-1 font-bold">ä¸€ã€ æŠ•æ³¨ç­‰çº§ä¸ç¬¦å·è§£é”ç³»ç»Ÿ</h3>
                                                    <p className="mb-1">æ ¹æ®å•æ¬¡æŠ•æ³¨é¢åº¦ï¼ˆBetï¼‰å†³å®šå¯å‚ä¸è®¡å¥–çš„ç¬¦å·ç§ç±»ï¼š</p>
                                                    <p className="mb-0">åŸºç¡€ (&lt; 50)ï¼š<code>ğŸ’€</code>(éšœç¢) / <code>ğŸ”§</code>(æ‰³æ‰‹) â€” åŸºç¡€æ¸¸æˆæ¨¡å¼</p>
                                                    <p className="mb-0">è¿›é˜¶ (50 - 99)ï¼šæ–°å¢ <code>ğŸ—</code>(ç«é¸¡) / <code>â˜¢ï¸</code>(æ”¾å°„)ï¼Œæ¿€æ´» <code>ğŸƒ</code>(ä¸‡èƒ½ç‰Œ)</p>
                                                    <p>å°Šäº« (â‰¥ 100 / VIP)ï¼šå…¨ç¬¦å·è§£é”ï¼ˆå« <code>ğŸ’</code> / <code>7ï¸âƒ£</code> / <code>â­</code>ï¼‰ï¼Œå¼€å¯æœ€é«˜å€ç‡å¥–åŠ±</p>
                                                </div>
                                                <div className="bg-slate-800 p-3 rounded border border-slate-700">
                                                    <h3 className="text-amber-400 text-lg mb-1 font-bold">äºŒã€ èµ”ç‡è¡¨ (Paylines & Payouts)</h3>
                                                    <p className="mb-1">å¥–é‡‘è®¡ç®—å…¬å¼ï¼š<span className="text-white">æ€»å¥–é‡‘ = (ä¸­å¥–å€æ•°ä¹‹å’Œ) Ã— (å½“å‰æŠ•æ³¨ Ã· 10)</span></p>
                                                    <p className="mb-0"><span className="text-slate-400">ç¬¦å· / 3è¿ / 4è¿ / 5è¿</span></p>
                                                    <p className="mb-0">å¹¸è¿ <code>7ï¸âƒ£</code>ï¼š80 / 250 / 1000</p>
                                                    <p className="mb-0">ç’€ç’¨ <code>ğŸ’</code>ï¼š40 / 100 / 500</p>
                                                    <p className="mb-0">æ”¾å°„ <code>â˜¢ï¸</code>ï¼š20 / 50 / 200</p>
                                                    <p className="mb-0">ç¾å‘³ <code>ğŸ—</code>ï¼š10 / 30 / 100</p>
                                                    <p>æ‰³æ‰‹ <code>ğŸ”§</code>ï¼š5 / 15 / 50</p>
                                                </div>
                                                <div className="bg-slate-800 p-3 rounded border border-slate-700">
                                                    <h3 className="text-green-400 text-lg mb-1 font-bold">ä¸‰ã€ æ ¸å¿ƒç©æ³•è§„åˆ™</h3>
                                                    <p className="mb-0">è¿çº¿åˆ¤å®šï¼šå…±æœ‰ 10 æ¡é»„é‡‘ä¸­å¥–çº¿ï¼Œç¬¦å·å¿…é¡»è‡ªå·¦å‘å³è¿ç»­æ’åˆ—ã€‚</p>
                                                    <p className="mb-0">ğŸƒ ä¸‡èƒ½ç‰Œ (Wild)ï¼šå¯æ›¿ä»£é™¤ <code>ğŸ’€</code> å’Œ <code>â­</code> ä¹‹å¤–çš„ä»»æ„ç¬¦å·ï¼ˆä»…åœ¨ä¸‹æ³¨â‰¥50æ—¶ç”Ÿæ•ˆï¼‰ã€‚</p>
                                                    <p className="mb-0">ğŸ’€ éšœç¢ç‰© (Blocker)ï¼šæ— æ³•å‚ä¸è¿çº¿ï¼Œä¸”ä¼šä¸­æ–­å…¶ä»–ç¬¦å·çš„è¿ç»­æ’åˆ—ã€‚</p>
                                                    <p>â­ æ•£å°„ç‰Œ (Scatter)ï¼šæ— éœ€åœ¨è¿çº¿ä¸Šï¼Œåªè¦å±å¹•ä»»æ„ä½ç½®é›†é½å³å¯å¥–åŠ±ã€‚</p>
                                                </div>
                                                <div className="bg-slate-800 p-3 rounded border border-slate-700">
                                                    <h3 className="text-purple-400 text-lg mb-1 font-bold">å››ã€ å¥–åŠ±æ¨¡å¼ (Bonus Features)</h3>
                                                    <p className="mb-1">1. å…è´¹æ‘‡å¥– (Free Spins)ï¼šå½“å±å¹•ä»»æ„ä½ç½®å‡ºç° <code>â­</code> æ—¶ï¼Œè§¦å‘å¯¹åº”æ¬¡æ•°çš„å…è´¹æ—‹è½¬ã€‚</p>
                                                    <p className="mb-0">3ä¸ª <code>â­</code>ï¼š5æ¬¡</p>
                                                    <p className="mb-0">4ä¸ª <code>â­</code>ï¼š10æ¬¡</p>
                                                    <p>5ä¸ª <code>â­</code>ï¼š20æ¬¡</p>
                                                    <p className="mb-1">2. æ”¾å°„ç‹‚çƒ­ (Fever Mode)ï¼š</p>
                                                    <p className="mb-0">èƒ½é‡ç§¯æ”’ï¼š3è¿ +1ç‚¹ï¼Œ4è¿ +2ç‚¹ï¼Œ5è¿ +3ç‚¹ã€‚</p>
                                                    <p className="mb-0">è¿›å…¥ç‹‚çƒ­ï¼šèƒ½é‡æ§½æ»¡ 42ç‚¹ è‡ªåŠ¨å¼€å¯ 5æ¬¡ ç‹‚çƒ­æ—‹è½¬ã€‚</p>
                                                    <p>ç‹‚çƒ­ç‰¹æƒï¼šå‰”é™¤ä½åˆ†ï¼ˆä¸å†å‡ºç° <code>ğŸ’€</code> å’Œ <code>ğŸ”§</code>ï¼‰ï¼Œå¥–é‡‘ä¹˜æ•°åŠ¨æ€åŠ æˆï¼šåŸºç¡€ Ã—1.5ï¼›è‹¥è¯¥è½®ä¸­å¥–çº¿è¶…è¿‡ 5 æ¡åˆ™ä¸´æ—¶æå‡è‡³ Ã—2ã€‚æ³¨ï¼šç‹‚çƒ­æœŸé—´èƒ½é‡æ§½ä¸å†å¢é•¿ã€‚</p>
                                                </div>
                                            </div>
                                            <button onClick={() => setShowCasinoRules(false)} className="w-full flex-none bg-slate-700 hover:bg-slate-600 text-white py-3 rounded text-xl border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 transition-all mt-2">
                                                æ˜ç™½
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {scene === 'combat' && raidState.currentEnemy && (
                                <div className="flex-1 flex flex-col h-full overflow-hidden fade-in justify-between">
                                   <div className="text-center mt-4">
                                      <div className={`inline-block p-4 rounded-full bg-slate-800 border-4 border-red-800 mb-2 ${raidState.isGlitchEnemy ? 'animate-pulse' : ''}`}><Skull size={64} className="text-red-500" /></div>
                                      <h2 className="text-3xl text-red-500 font-bold tracking-widest">{raidState.currentEnemy.name}</h2>
                                      <div className="w-2/3 mx-auto mt-2"><ProgressBar current={raidState.currentEnemy.hp} max={raidState.currentEnemy.maxHp} color="bg-red-600" /></div>
                                   </div>
                                   <div className="flex justify-between px-4 text-xl border-t border-b border-slate-700 py-2 bg-black/30"><div className="text-green-400">HP: {raidState.currentEnemy.hp}/{raidState.currentEnemy.maxHp}</div><div className="text-yellow-400">ATK: {raidState.currentEnemy.atk} DMG</div></div>
                                   <div className="grid grid-cols-2 gap-4 mb-2">
                                      <button onClick={() => handleCombat('attack')} className="p-6 bg-red-900/40 border-2 border-red-600 hover:bg-red-800/60 rounded flex flex-col items-center justify-center group"><Sword size={48} className="text-red-500 mb-2" /><span className="text-2xl text-red-300 font-bold">æ”»å‡»</span></button>
                                      <button onClick={() => handleCombat('flee')} className="p-6 bg-slate-800 border-2 border-slate-600 hover:bg-slate-700 rounded flex flex-col items-center justify-center group"><Footprints size={48} className="text-slate-400 mb-2" /><span className="text-2xl text-slate-300">é€ƒè·‘</span></button>
                                   </div>
                                </div>
                            )}

                            {scene === 'hideout' && (
                              <div className="flex-1 flex flex-col h-full overflow-hidden fade-in min-h-0">
                                <h2 className="flex-none bg-[#1a1c21] z-10 text-center text-2xl text-orange-400 mb-4 border-b border-slate-700 py-2">=== è®¾æ–½å‡çº§ ===</h2>
                                <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-2">
                                    {player.facilities.workbench && (
                                        <div className="bg-slate-800 p-3 mb-4 rounded border border-blue-500/50">
                                            <h3 className="text-lg text-blue-400 mb-2">ç²¾å¯†å·¥ä½œå°</h3>
                                            <button onClick={craftAmmo} className="w-full bg-slate-700 hover:bg-slate-600 text-lg py-2 rounded border border-slate-600">åˆ¶é€ å¼¹è¯ç®± ($50 + 1åºŸé’¢)</button>
                                        </div>
                                    )}
                                    {Object.entries(FACILITIES).map(([key, fac]) => {
                                        const isBuilt = player.facilities[key];
                                        return (
                                            <div key={key} className={`p-3 border rounded ${isBuilt ? 'border-green-500/50 bg-green-900/10' : 'border-slate-600 bg-slate-800'}`}>
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className={`text-xl ${isBuilt ? 'text-green-400' : 'text-slate-200'}`}>{fac.name}</span>
                                                    {isBuilt && <span className="text-sm bg-green-900 text-green-300 px-2 rounded">å·²å»ºé€ </span>}
                                                </div>
                                                <p className="text-sm text-slate-400 mb-2">{fac.desc}</p>
                                                {!isBuilt && (
                                                    <div className="mt-2">
                                                        <div className="text-sm text-slate-500 mb-1">æ‰€éœ€ææ–™:</div>
                                                        <div className="grid grid-cols-2 gap-1 mb-2">
                                                            {Object.entries(fac.cost).map(([mat, count]) => {
                                                                const has = countItemInStorage(mat);
                                                                return ( <span key={mat} className={`text-sm ${has >= count ? 'text-green-500' : 'text-red-500'}`}>{mat}: {has}/{count}</span> )
                                                            })}
                                                        </div>
                                                        <button onClick={() => upgradeFacility(key)} className="w-full bg-orange-700 hover:bg-orange-600 text-white text-lg py-2 rounded">å»ºé€ è®¾æ–½</button>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="flex-none pt-3 border-t border-slate-700 mt-2"><button onClick={() => setScene('home')} className="w-full bg-slate-700 p-3 text-xl hover:bg-slate-600 border border-slate-500 text-slate-300 rounded">è¿”å›</button></div>
                              </div>
                            )}

                            {scene === 'storage' && (
                                <div className="flex-1 flex flex-col h-full overflow-hidden fade-in min-h-0">
                                    <div className="flex-none flex justify-between items-center border-b border-slate-700 pb-2 mb-2 pt-2 bg-[#1a1c21]">
                                        <h2 className="text-2xl text-blue-400 tracking-widest">=== ä»“åº“ ===</h2>
                                        <button onClick={sellAllLoot} className="text-base bg-red-900/50 text-red-300 px-3 py-1 rounded hover:bg-red-800 border border-red-700 flex items-center gap-1"><Trash2 size={16} /> å–æ‚ç‰©</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-2 pr-1 pb-2">
                                        {player.storage.length === 0 ? <div className="text-center text-slate-600 mt-10 text-xl">ä»“åº“ç©ºç©ºå¦‚ä¹Ÿ...</div> : 
                                            groupItems(player.storage).map((g, idx) => (
                                                <div key={idx} className={`p-3 border rounded flex justify-between items-center ${RARITY_CONFIG[g.item.rarity || 'white'].border} ${RARITY_CONFIG[g.item.rarity || 'white'].bg}`}>
                                                    <div>
                                                        <div className={`${RARITY_CONFIG[g.item.rarity || 'white'].color} text-xl`}>{g.item.name}*{g.count}</div>
                                                        <div className="text-sm text-slate-500 mt-0.5">{g.item.type === 'consumable' ? 'é£Ÿç‰©/è¯å“' : g.item.type === 'relic' ? 'é—ç‰©' : isMaterial(g.item) ? 'ææ–™' : 'æ‚ç‰©'}</div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        {g.item.type === 'consumable' || g.item.type === 'relic' ? (
                                                            <button onClick={() => useOneByKey(g.key)} className="bg-green-700 hover:bg-green-600 text-white px-3 py-1 text-lg rounded">{g.item.type === 'relic' ? 'è£…å¤‡' : 'ä½¿ç”¨'}</button>
                                                        ) : (
                                                            <button onClick={() => sellOneByKey(g.key)} className="bg-slate-700 hover:bg-slate-600 text-yellow-400 px-3 py-1 text-lg rounded border border-slate-600 flex items-center gap-1"><Coins size={16}/> ${g.item.val}</button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                    <div className="flex-none pt-3 border-t border-slate-700 mt-2"><button onClick={() => setScene('home')} className="w-full bg-slate-700 p-3 text-xl hover:bg-slate-600 border border-slate-500 text-slate-300 rounded">è¿”å›</button></div>
                                </div>
                            )}

                            {scene === 'equipment' && (
                                <div className="flex-1 flex flex-col h-full overflow-hidden fade-in min-h-0">
                                    <div className="flex-none flex justify-between items-center border-b border-slate-700 pb-2 mb-2 pt-2 bg-[#1a1c21]">
                                        <h2 className="text-2xl text-slate-300 tracking-widest">=== è£…å¤‡ ===</h2>
                                        <div className="text-slate-400 text-base">WPN {player.weapon.atk} / ARM {player.armor.def}</div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pr-1 pb-2">
                                        <div className="p-3 border rounded bg-slate-800 border-slate-600">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <Sword className="text-red-500" size={24} />
                                                    <span className="text-xl text-red-400">{player.weapon.name}</span>
                                                </div>
                                                <div className="text-red-400 text-lg">ATK {player.weapon.atk}</div>
                                            </div>
                                            <div className="text-slate-400 text-base mt-1">{player.weapon.desc}</div>
                                        </div>
                                        <div className="p-3 border rounded bg-slate-800 border-slate-600">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <Shield className="text-blue-500" size={24} />
                                                    <span className="text-xl text-blue-400">{player.armor.name}</span>
                                                </div>
                                                <div className="text-blue-400 text-lg">DEF {player.armor.def || 0}</div>
                                            </div>
                                            <div className="text-slate-400 text-base mt-1">{player.armor.desc}</div>
                                        </div>
                                        <div className="p-3 border rounded bg-slate-800 border-slate-600">
                                            <div className="flex items-center justify-between mb-2">
                                                <div className="flex items-center gap-2">
                                                    <Gem className="text-purple-400" size={20} />
                                                    <span className="text-xl text-slate-200">é—ç‰©</span>
                                                </div>
                                                <div className="text-slate-500 text-sm">{player.relics.length} ä»¶</div>
                                            </div>
                                            {player.relics.length === 0 ? (
                                                <div className="text-center text-slate-600 py-4">æœªè£…å¤‡é—ç‰©</div>
                                            ) : (
                                                <div className="space-y-2">
                                                    {player.relics.map((r, i) => (
                                                        <div key={i} className={`p-2 border rounded flex justify-between items-center ${RARITY_CONFIG[r.rarity || 'purple'].border} ${RARITY_CONFIG[r.rarity || 'purple'].bg}`}>
                                                            <div className={`${RARITY_CONFIG[r.rarity || 'purple'].color} text-lg`}>{r.name}</div>
                                                            <div className="text-slate-400 text-base ml-4 flex-1 text-right">{r.desc}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex-none pt-3 border-t border-slate-700 mt-2">
                                        <button onClick={() => setScene('home')} className="w-full bg-slate-700 p-3 text-xl hover:bg-slate-600 border border-slate-500 text-slate-300 rounded">è¿”å›</button>
                                    </div>
                                </div>
                            )}

                            {scene === 'raid' && (
                                <div className="flex-1 flex flex-col justify-between fade-in h-full">
                                    <div className="text-center space-y-6 mt-8">
                                        <div className="relative inline-block"><Footprints className="mx-auto text-slate-600" size={64} /><div className="absolute top-0 right-0 animate-ping h-3 w-3 rounded-full bg-red-500 opacity-75"></div></div>
                                        <div className="space-y-2"><div className="text-xl text-slate-500">æ­£åœ¨æœç´¢åŒºåŸŸ...</div><div className="text-5xl font-bold text-slate-200 tracking-widest">{raidState.distance}m</div></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 mt-auto mb-2">
                                         <PixelCard onClick={explore} className="bg-slate-800 hover:bg-green-900/20 border-green-800/50"><div className="text-center py-2"><span className="text-2xl font-bold text-green-500 block mb-1">&gt; ç»§ç»­æœå¯»</span><span className="text-lg text-slate-500">æ¶ˆè€—5é¥±é£Ÿ/2San</span></div></PixelCard>
                                         <PixelCard onClick={evac} className="bg-slate-800 hover:bg-blue-900/20 border-blue-800/50"><div className="text-center py-2"><span className="text-2xl font-bold text-blue-500 block mb-1">&lt; å‘¼å«æ’¤ç¦»</span></div></PixelCard>
                                    </div>
                                </div>
                            )}

                            {scene === 'event' && raidState.currentLootItem && (
                                <div className="flex-1 flex flex-col items-center justify-center text-center fade-in">
                                   <div className={`p-6 bg-slate-900 rounded-full mb-6 border-4 ${RARITY_CONFIG[raidState.currentLootItem.rarity].border} shadow-[0_0_20px_rgba(0,0,0,0.5)]`}>
                                       {raidState.currentLootItem.rarity === 'special' ? <Radio size={64} className={`${RARITY_CONFIG[raidState.currentLootItem.rarity].color}`} /> : <Briefcase size={64} className={`${RARITY_CONFIG[raidState.currentLootItem.rarity].color}`} />}
                                   </div>
                                   <div className="mb-2 text-lg uppercase tracking-widest text-slate-500">{RARITY_CONFIG[raidState.currentLootItem.rarity].label} ç‰©èµ„</div>
                                   <h2 className={`text-4xl mb-4 tracking-wide ${RARITY_CONFIG[raidState.currentLootItem.rarity].color}`}>{raidState.currentLootItem.name}</h2>
                                   <div className="text-2xl text-slate-300 mb-8"><p className="bg-slate-800 p-3 rounded border border-slate-600 inline-block px-6">ä¼°å€¼: <span className="text-yellow-400 font-bold">${raidState.currentLootItem.val}</span></p></div>
                                   <button onClick={() => setScene('raid')} className="w-full max-w-[240px] py-4 bg-slate-700 hover:bg-slate-600 text-2xl rounded">æ”¶å…¥èƒŒåŒ…</button>
                                </div>
                           )}

                           {scene === 'interactive_event' && raidState.currentInteractiveEvent && (
                            <div className="flex-1 flex flex-col justify-center text-center fade-in overflow-y-auto min-h-0">
                                <div className="mb-6"><HelpCircle size={80} className="mx-auto text-blue-400 mb-4 animate-bounce" /><p className="text-2xl text-slate-200 leading-snug">{raidState.currentInteractiveEvent.text}</p></div>
                                <div className="space-y-3">
                                    {raidState.currentInteractiveEvent.choices.map(choice => (
                                        <button key={choice.id} onClick={() => handleEventChoice(choice)} className="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 p-4 rounded text-left group">
                                            <span className="block text-blue-300 text-xl group-hover:text-blue-200">{choice.text}</span>
                                            {choice.req && <span className="block text-sm text-red-400 mt-1">éœ€è¦: {choice.req.item ? ITEMS[choice.req.item]?.name || choice.req.item : `${choice.req.stat} ${choice.req.val}`}</span>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                            {(scene === 'result' || scene === 'gameover') && (
                                <div className="flex-1 flex flex-col items-center justify-center text-center fade-in">
                                    {scene === 'result' ? (
                                        <>
                                            <Briefcase size={96} className="text-green-600 mb-6" />
                                            <h2 className="text-4xl text-green-500 mb-4 tracking-widest">æ’¤ç¦»æˆåŠŸ</h2>
                                            <div className="bg-black/20 p-4 rounded border border-slate-700 mb-8 max-h-48 overflow-y-auto w-full">
                                                <div className="text-base text-slate-500 mb-2 uppercase border-b border-slate-600">è·å¾—ç‰©å“</div>
                                                {groupItems(raidState.tempLoot).map((g, i) => (<div key={i} className={`flex justify-between text-lg ${RARITY_CONFIG[g.item.rarity].color}`}><span>{g.item.name}*{g.count}</span><span>${g.totalVal}</span></div>))}
                                                <div className="mt-2 pt-2 border-t border-slate-600 flex justify-between font-bold text-yellow-500 text-xl"><span>æ€»ä¼°å€¼</span><span>${raidState.tempLoot.reduce((a,b)=>a+b.val, 0)}</span></div>
                                            </div>
                                            <button onClick={() => setScene('storage')} className="px-8 py-4 bg-blue-900/30 border-2 border-blue-800 text-blue-400 text-2xl rounded hover:bg-blue-900/50 transition-colors">å‰å¾€ä»“åº“æ•´ç†</button>
                                        </>
                                    ) : (
                                        <>
                                            <Skull size={96} className="text-slate-700 mb-6" />
                                            <h2 className="text-4xl text-red-600 mb-4 tracking-widest">è¡ŒåŠ¨å¤±è´¥</h2>
                                            <button onClick={resetGame} className="px-8 py-4 bg-red-900/30 border-2 border-red-800 text-red-400 text-2xl rounded">é‡æ–°å¼€å§‹</button>
                                        </>
                                    )}
                                </div>
                            )}

                            {scene === 'victory' && (
                                <div className="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-6 bg-black/90 z-[70] absolute inset-0 rounded-lg fade-in">
                                    <div className="animate-bounce mb-4"><Rocket size={80} className="text-yellow-400" /></div>
                                    <h2 className="text-5xl text-yellow-400 font-bold tracking-[0.2em] mb-4">å›å½’ç°å®</h2>
                                    <div className="space-y-4 max-w-sm">
                                        <p className="text-green-400 text-xl leading-relaxed">
                                            éšç€æœ€å $32,500 çš„æ±‡å…¥ï¼Œå†™å­—æ¥¼é‚£æ²‰é‡çš„é“é—¨å‘å‡ºäº†ä½æ²‰çš„é¸£å“ã€‚
                                        </p>
                                        <p className="text-green-500 text-lg opacity-80 italic">
                                            åˆºçœ¼çš„é˜³å…‰é‡æ–°æ´’è½ï¼ŒåºŸå¢Ÿçš„å½±åƒå¦‚ç ´ç¢çš„åƒç´ ç‚¹èˆ¬æ¶ˆæ•£ã€‚
                                        </p>
                                        <p className="text-green-400 text-xl font-bold">
                                            ä½ å›åˆ°äº†é™¤å¤•çš„åˆå¤œã€‚
                                        </p>
                                        <div className="bg-slate-900 border border-slate-700 p-4 mt-8 rounded">
                                            <div className="text-slate-500 text-sm uppercase">ç”Ÿå­˜ç»Ÿè®¡</div>
                                            <div className="text-2xl text-yellow-500 mt-2 font-bold">${player.money.toLocaleString()}</div>
                                            <div className="text-slate-500 text-sm">é€ƒå‡ºç”Ÿå¤©ï¼</div>
                                        </div>
                                    </div>
                                    <button onClick={resetGame} className="mt-8 px-8 py-4 bg-yellow-900/40 border-2 border-yellow-500 text-yellow-400 text-2xl hover:bg-yellow-800 rounded">å†æ¬¡æŒ‘æˆ˜ ></button>
                                </div>
                            )}

                        </div>
                    )}

                    {scene !== 'intro' && scene !== 'victory' && (
                        <div className="h-20 bg-black p-3 overflow-y-auto font-mono text-base md:text-lg border-t-4 border-slate-700 z-10 no-scrollbar flex flex-col-reverse tracking-wide leading-snug flex-none">
                            {logs.map((log, i) => (
                                <div key={i} className={`mb-1 border-l-2 pl-2 ${
                                    log.includes('danger') || log.includes('å—åˆ°') || log.includes('å¤±è´¥') || log.includes('ç¼ºå°‘') ? 'text-red-500 border-red-900' : 
                                    log.includes('success') || log.includes('è·å¾—') || log.includes('å‡ºå”®') || log.includes('å»ºé€ ') ? 'text-green-500 border-green-900' : 
                                    log.includes('blue') ? 'text-blue-400 border-blue-900' :
                                    'text-slate-500 border-slate-800'
                                }`}>
                                    <span className="opacity-50 mr-2">{log.match(/\[(.*?)\]/)?.[0] || '>'}</span>
                                    {log.replace(/\[.*?\] /, '').replace('danger', '').replace('success', '').replace('error', '').replace('blue', '')}
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                <div className="mt-6 flex-none flex justify-between items-center px-6 opacity-80">
                     <div className="grid grid-cols-3 gap-1 w-24 h-24">
                        <div className="bg-slate-700 rounded col-start-2"></div>
                        <div className="bg-slate-700 rounded col-start-1 row-start-2"></div>
                        <div className="bg-slate-800 rounded col-start-2 row-start-2 flex items-center justify-center"><div className="w-3 h-3 rounded-full bg-black/30"></div></div>
                        <div className="bg-slate-700 rounded col-start-3 row-start-2"></div>
                        <div className="bg-slate-700 rounded col-start-2 row-start-3"></div>
                     </div>
                     <div className="flex gap-6 transform rotate-12">
                         <div className="w-12 h-12 rounded-full bg-red-800 shadow-[0_4px_0_rgb(80,0,0)] border-t border-red-600"></div>
                         <div className="w-12 h-12 rounded-full bg-red-800 shadow-[0_4px_0_rgb(80,0,0)] border-t border-red-600"></div>
                     </div>
                </div>

              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExtractionGame />);
    </script>
</body>
</html>
